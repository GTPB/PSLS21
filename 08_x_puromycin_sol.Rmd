---
title: "Experimental Design II: replication and power"
author: "Lieven Clement & Alexandre Segers"
date: "statOmics, Ghent University (https://statomics.github.io)"
output:
  html_document:
    code_download: yes
    theme: cosmo
    toc: yes
    toc_float: yes
    highlight: tango
    number_sections: yes
---


<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a>

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
```

# Puromycin data

Data on the velocity of an enzymatic reaction were obtained by Treloar (1974).  
The number of counts per minute of radioactive product from the reaction was 
measured as a function of substrate concentration in parts per million (ppm) and
from these counts the initial rate (or velocity) of the reaction was calculated (counts/min/min). The experiment was conducted once with the enzyme treated
with Puromycin, and once with the enzyme untreated.

Assess if there is an association between the substrate concentration and rate 
**for both the treated and untreated enzymes.**

# Import data

```{r}
data(Puromycin)
```

# Data wrangling

For a clearer interpretation of the model parameters later on, we will make
the untreated state enzymes the reference category.

```{r}
Puromycin <- Puromycin %>%
    mutate(state =fct_relevel(state,c("untreated","treated")))
```

## Data Exploration

First, we visualize the association between the concentration and the enzyme 
rate, for both of the enzyme states. 

```{r}
Puromycin  %>%
  ggplot(aes(x=conc,y=rate)) +
  geom_point() + 
  stat_smooth(method = "loess",col="red") + # fit een kromme door de punten (rode lijn)
  stat_smooth(method='lm',col="black") + # fit een rechte door de punten aan de hand van de kleinstekwadratenmethode
  ylab("Reaction rate (counts/min)") +
  xlab("Substrate concentratie (ppm)") +
  facet_grid(~state)
```

The plot shows that there is a relation between the velocity and the 
concentration, however, the relation does not seem to be linear. 

We will assess the impact of log-transforming the concentration. Because the 
concentration is measured in ppm we will log$_{10}$ transform the data. 

```{r}
Puromycin  %>%
  ggplot(aes(x=conc %>% log10,y=rate)) +
  geom_point() + 
  stat_smooth(method = "loess",col="red") + 
  stat_smooth(method='lm',col="black") +
  ylab("Reaction Rate (counts/min)") +
  xlab("log10(Substrate concentration) (log10 ppm)") +
  facet_grid(~state)
```

The relation between the velocity and the log$_{10}$ transformed concentration 
seems to be linear. 

# Linear regression 

We will fit the following model to the data 

$Y_i = \beta_0 + \beta_c log_{10}(x_c)+ \beta_s(x_s) + +\beta_{c:s}x_{c}x_{s} + \epsilon_i$

with 

- $Y_i$ the reaction rate,

- $\beta_0$ the intercept,

- $\beta_{c}$ the main effect for log10 concentration,

- $x_c$ the adopted concentration,

- $\beta_{s}$ the main effect treatment state,

- $x_s$ a dummy variable that is 0 for the enzymes that are untreated and 1 for
the treated enzymes,

- $\beta_{cs}$ the interaction effect between concentration and treatment state,

- $\epsilon_i$ i.i.d. normally distributed with mean 0 and variance $\sigma^2$.

Note, that we write the substrate concentration with a small letter because 
the predictor is not random. The researchers have chosen the substrate 
concentrations in the design phase and it is thus no random variable.

```{r}
mod1 <- lm(rate ~ conc %>% log10 * state, Puromycin)
summary(mod1)
```

Before we perform inference we will first assess the assumptions

## Assumptions 

1. Independence 
2. Linearity
3. Normal distribution of the residuals
4. Homoscedasticity 

We assume that the experiment was well designed and that the different reactions that were use in the experiment are independent.

## Linearity 

We assess linearity in a residual analysis 

```{r}
plot(mod1, which=1)
```

The assumption of linearity is met.

### Normality 

```{r}
plot(mod1,which=2)
```

The QQ-plot does not show large deviations from normality. 

### Homoscedasticity: equality of the variance

We can again use the residual plot for assessing this assumption or the plot 
were we plot the square root of the standardized residuals in function of 
the fit. 

```{r}
plot(mod1, which=3)
```

We see that the spread of the majority of the residuals is more or less similar.
As such, we may assume homoscedaticity of the data.

## Inference 

### hypotheses 

We want to assess if there is a linear association between the reaction rate and
the log$_{10}$ transformed concentration. 

So we will assess 

$H_0$: $\beta_1 = 0$
 
agains 

$H_A$: $\beta_1 \ne 0$ 

using a t-test on the slope parameter. 

```{r}
summary(mod1)
confint(mod1)
```


### Conclusion

There is an extremely significant linear association between the substrate concentration on the log-scale and the reaction rate (p<<0.001). 
A reaction at a substrate concentration that is 10 times higher will have a reaction speed that is on average  `r round(mod1$coef[2],1)` counts/min higher (95% CI [`r round(confint(mod1)[2,],1)`] counts/min). 



