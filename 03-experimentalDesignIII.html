<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Lieven Clement" />


<title>3.3 Experimental Design III: Randomized Complete Block Designs and Pseudo-replication</title>

<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<script src="site_libs/navigation-1.1/sourceembed.js"></script>
<script src="site_libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>


<style type="text/css">
#rmd-source-code {
  display: none;
}
</style>


<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">PSLS21</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-chalkboard-teacher"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01-intro.html">1. Introduction</a>
    </li>
    <li>
      <a href="02-concepts.html">2. Concepts</a>
    </li>
    <li>
      <a href="03-experimentalDesign.html">3.1. Experimental Design I</a>
    </li>
    <li>
      <a href="03-experimentalDesignII.html">3.1. Experimental Design I</a>
    </li>
    <li>
      <a href="04-dataExploration.html">4. Data Exploration</a>
    </li>
    <li>
      <a href="05-statisticalInference.html">5.1 Statistical Inference 1</a>
    </li>
    <li>
      <a href="05-statisticalInference-twosampleT.html">5.2 Statistical Inference 2</a>
    </li>
    <li>
      <a href="06-linearRegression.html">6. Linear Regression</a>
    </li>
    <li>
      <a href="07-Anova.html">7. Analysis of Variance</a>
    </li>
    <li>
      <a href="08-MultipleRegression.html">8. Multiple Regression</a>
    </li>
    <li>
      <a href="08-MultipleRegression-SpecificDesigns.html">8.2 Multiple Regression: Factorial Designs</a>
    </li>
    <li>
      <a href="09-NonparametericStatistics-WilcoxonMannWithney.html">9.1. Nonparametric Statistics 1</a>
    </li>
    <li>
      <a href="09-NonparametericStatistics-KruskalWallis.html">9.2. Nonparametric Statistics 2</a>
    </li>
    <li>
      <a href="10-categoricalDataAnalysis.html">10. Categorical Data Analysis</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-laptop"></span>
     
    Labs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Lab 1</li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/statOmics/PSLS21">
    <span class="fab fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://statomics.github.io/">statOmics</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
<li role="separator" class="divider"></li>
<li><a id="rmd-download-source" href="#">Download Rmd</a></li>
</ul>
</div>



<h1 class="title toc-ignore">3.3 Experimental Design III: Randomized Complete Block Designs and Pseudo-replication</h1>
<h4 class="author">Lieven Clement</h4>
<h4 class="date">statOmics, Ghent University (<a href="https://statomics.github.io" class="uri">https://statomics.github.io</a>)</h4>

</div>


<p><a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(tidyverse)</span></code></pre></div>
<pre><code>## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.3.5     ✔ purrr   0.3.4
## ✔ tibble  3.1.4     ✔ dplyr   1.0.7
## ✔ tidyr   1.1.4     ✔ stringr 1.4.0
## ✔ readr   2.0.2     ✔ forcats 0.5.1</code></pre>
<pre><code>## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div id="randomized-complete-block-designs" class="section level1">
<h1><span class="header-section-number">1</span> Randomized complete block designs</h1>
<p><span class="math display">\[\sigma^2= \sigma^2_{bio}+\sigma^2_\text{lab} +\sigma^2_\text{extraction} + \sigma^2_\text{run} + \ldots\]</span></p>
<ul>
<li>Biological: fluctuations in protein level between mice, fluctations in protein level between cells, …</li>
<li>Technical: cage effect, lab effect, week effect, plasma extraction, MS-run, …</li>
</ul>
</div>
<div id="nature-methods-points-of-significance---blocking" class="section level1">
<h1><span class="header-section-number">2</span> Nature methods: Points of significance - Blocking</h1>
<p><a href="https://www.nature.com/articles/nmeth.3005.pdf">https://www.nature.com/articles/nmeth.3005.pdf</a></p>
<ul>
<li><p>Oneway anova is a special case of a completely randomized design:</p>
<ul>
<li>the experimental units are sampled at random from the population</li>
<li>the treatments are randomized to the experimental units</li>
<li>Every experimental unit receives one treatment and its response variable is measured once.</li>
</ul></li>
<li><p>In a block design the experimental units are blocks which are sampled at random of the population of all possible blocks.</p>
<ul>
<li>The RCB restricts randomization: the treatments are randomized within the blocks.</li>
<li>it cannot be analysed using oneway anova.</li>
<li>The paired design is a special case of an RCB: block size equals 2.</li>
<li>Within block effects can be assessed using the lm function in R.</li>
</ul></li>
</ul>
</div>
<div id="mouse-example" class="section level1">
<h1><span class="header-section-number">3</span> Mouse example</h1>
<div id="background" class="section level2">
<h2><span class="header-section-number">3.1</span> Background</h2>
<p><img src="https://raw.githubusercontent.com/statOmics/PSLS21/master/figures/mouseTcell_RCB_design.png" width="50%" /></p>
<p>Duguet et al. (2017) MCP 16(8):1416-1432. doi: 10.1074/mcp.m116.062745</p>
<ul>
<li>All treatments of interest are present within block!</li>
<li>We can estimate the effect of the treatment within block!</li>
</ul>
<p>We focus on one protein</p>
<ul>
<li>The measured intensities are already on the log2-scale. Differences between the intensities can thus be interpreted as log2 FC.</li>
<li>P16045 or Galectin-1.</li>
<li>Function: “Lectin that binds beta-galactoside and a wide array of complex carbohydrates. Plays a role in regulating apoptosis, cell proliferation and cell differentiation. Inhibits CD45 protein phosphatase activity and therefore the dephosphorylation of Lyn kinase. Strong inducer of T-cell apoptosis.” (source: <a href="https://www.uniprot.org/uniprot/P16045">uniprot</a>)</li>
</ul>
</div>
<div id="data-exploration" class="section level2">
<h2><span class="header-section-number">3.2</span> Data Exploration</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>mouse &lt;-<span class="st"> </span><span class="kw">read_tsv</span>(<span class="st">&quot;https://raw.githubusercontent.com/statOmics/PSLS21/data/mouseP16045.txt&quot;</span>)</span></code></pre></div>
<pre><code>## Rows: 14 Columns: 3</code></pre>
<pre><code>## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;\t&quot;
## chr (2): celltype, mouse
## dbl (1): intensity</code></pre>
<pre><code>## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>mouse</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["celltype"],"name":[1],"type":["chr"],"align":["left"]},{"label":["mouse"],"name":[2],"type":["chr"],"align":["left"]},{"label":["intensity"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"Tcon","2":"m1","3":"9.467"},{"1":"Tcon","2":"m2","3":"10.022"},{"1":"Tcon","2":"m3","3":"10.604"},{"1":"Tcon","2":"m4","3":"10.328"},{"1":"Tcon","2":"m5","3":"9.929"},{"1":"Tcon","2":"m6","3":"11.237"},{"1":"Tcon","2":"m7","3":"11.709"},{"1":"Treg","2":"m1","3":"10.470"},{"1":"Treg","2":"m2","3":"10.926"},{"1":"Treg","2":"m3","3":"11.384"},{"1":"Treg","2":"m4","3":"11.318"},{"1":"Treg","2":"m5","3":"11.584"},{"1":"Treg","2":"m6","3":"12.911"},{"1":"Treg","2":"m7","3":"13.123"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>mouse <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> mouse, <span class="dt">y=</span> intensity, <span class="dt">col=</span>celltype)) <span class="op">+</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="st">  </span><span class="kw">geom_point</span>()</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>mouse <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> celltype, <span class="dt">y=</span> intensity)) <span class="op">+</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="st">    </span><span class="kw">geom_boxplot</span>(<span class="kw">aes</span>(<span class="dt">col=</span>celltype),<span class="dt">outlier.shape =</span> <span class="ot">NA</span>) <span class="op">+</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group =</span> mouse)) <span class="op">+</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">col=</span>celltype))</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
</div>
<div id="paired-analysis" class="section level2">
<h2><span class="header-section-number">3.3</span> Paired Analysis</h2>
<p>This is a paired design, which is the most simple form of randomized complete block design.</p>
<p>In the previous lecture we would have analyzed the data by differencing.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>mouseWide &lt;-<span class="st"> </span>mouse <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="st">  </span><span class="kw">spread</span>(celltype,intensity) <span class="op">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">delta =</span> Treg <span class="op">-</span><span class="st"> </span>Tcon)</span>
<span id="cb12-4"><a href="#cb12-4"></a>mouseWide</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["mouse"],"name":[1],"type":["chr"],"align":["left"]},{"label":["Tcon"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Treg"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["delta"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"m1","2":"9.467","3":"10.470","4":"1.003"},{"1":"m2","2":"10.022","3":"10.926","4":"0.904"},{"1":"m3","2":"10.604","3":"11.384","4":"0.780"},{"1":"m4","2":"10.328","3":"11.318","4":"0.990"},{"1":"m5","2":"9.929","3":"11.584","4":"1.655"},{"1":"m6","2":"11.237","3":"12.911","4":"1.674"},{"1":"m7","2":"11.709","3":"13.123","4":"1.414"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div id="data-exploration-1" class="section level3">
<h3><span class="header-section-number">3.3.1</span> Data exploration</h3>
<ul>
<li>Boxplot of difference</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>mouseWide <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span><span class="st">&quot;&quot;</span>,<span class="dt">y=</span>delta)) <span class="op">+</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">  </span><span class="kw">geom_boxplot</span>(<span class="dt">outlier.shape =</span> <span class="ot">NA</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">  </span><span class="kw">geom_jitter</span>()</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<ul>
<li>Summary statistics</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>deltaSum &lt;-<span class="st"> </span>mouseWide <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="st">  </span><span class="kw">summarize_at</span>(<span class="st">&quot;delta&quot;</span>, </span>
<span id="cb14-3"><a href="#cb14-3"></a>               <span class="kw">list</span>(</span>
<span id="cb14-4"><a href="#cb14-4"></a>                    <span class="dt">mean =</span> <span class="op">~</span><span class="st"> </span><span class="kw">mean</span>(.,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb14-5"><a href="#cb14-5"></a>                    <span class="dt">sd =</span> <span class="op">~</span><span class="st"> </span><span class="kw">sd</span>(.,<span class="dt">na.rm =</span> <span class="ot">TRUE</span>),</span>
<span id="cb14-6"><a href="#cb14-6"></a>                    <span class="dt">n =</span> <span class="op">~</span><span class="st"> </span><span class="kw">is.na</span>(.) <span class="op">%&gt;%</span><span class="st"> `</span><span class="dt">!</span><span class="st">`</span> <span class="op">%&gt;%</span><span class="st"> </span>sum</span>
<span id="cb14-7"><a href="#cb14-7"></a>                   )</span>
<span id="cb14-8"><a href="#cb14-8"></a>               ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">se =</span> sd<span class="op">/</span><span class="kw">sqrt</span>(n))</span>
<span id="cb14-10"><a href="#cb14-10"></a>deltaSum</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["mean"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["sd"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[3],"type":["int"],"align":["right"]},{"label":["se"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"1.202857","2":"0.3706672","3":"7","4":"0.140099"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<ul>
<li>Covariance and correlation between expression in both celltypes</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">cor</span>(mouseWide[,<span class="kw">c</span>(<span class="st">&quot;Tcon&quot;</span>,<span class="st">&quot;Treg&quot;</span>)])</span></code></pre></div>
<pre><code>##         Tcon    Treg
## Tcon 1.00000 0.93874
## Treg 0.93874 1.00000</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">var</span>(mouseWide[,<span class="kw">c</span>(<span class="st">&quot;Tcon&quot;</span>,<span class="st">&quot;Treg&quot;</span>)])</span></code></pre></div>
<pre><code>##           Tcon      Treg
## Tcon 0.6101531 0.7245316
## Treg 0.7245316 0.9763042</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">var</span>(mouseWide[,<span class="kw">c</span>(<span class="st">&quot;Tcon&quot;</span>,<span class="st">&quot;Treg&quot;</span>)]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="st">  </span>diag <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="st">  </span>sqrt</span></code></pre></div>
<pre><code>##      Tcon      Treg 
## 0.7811230 0.9880811</code></pre>
<p>Notice that there is a large correlation between the expression of the protein in conventional and regulatory T-cells.</p>
<ul>
<li>Standard deviation of difference?</li>
</ul>
<p><span class="math display">\[
\begin{array}{lcl}
\text{sd}_{x_r - x_c} &amp;=&amp; \sqrt{1^2\hat \sigma_r^2 + (-1)^2 \hat \sigma_c^2 + 2 \times 1 
\times -1 
\times \hat\sigma_{r,c}}\\
&amp;=&amp;\sqrt{\hat \sigma_r^2 + \hat \sigma_c^2 - 2 \times \hat\sigma_{r,c}}
\end{array}
\]</span></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>sdDelta2 &lt;-<span class="st"> </span>(<span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>) <span class="op">%*%</span><span class="st"> </span><span class="kw">var</span>(mouseWide[,<span class="kw">c</span>(<span class="st">&quot;Tcon&quot;</span>,<span class="st">&quot;Treg&quot;</span>)]) <span class="op">%*%</span><span class="st"> </span><span class="kw">c</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)) <span class="op">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="st">  </span>sqrt</span>
<span id="cb21-3"><a href="#cb21-3"></a>sdDelta2</span></code></pre></div>
<pre><code>##           [,1]
## [1,] 0.3706672</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>seDeltaBar &lt;-<span class="st"> </span>sdDelta2 <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(deltaSum<span class="op">$</span>n)</span>
<span id="cb23-2"><a href="#cb23-2"></a>seDeltaBar</span></code></pre></div>
<pre><code>##          [,1]
## [1,] 0.140099</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>deltaSum</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["mean"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["sd"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[3],"type":["int"],"align":["right"]},{"label":["se"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"1.202857","2":"0.3706672","3":"7","4":"0.140099"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<ul>
<li>The standard deviation on the difference is much lower because of the strong correlation!</li>
<li>Note, that the paired design enabled us to estimate the difference in log2-expression between the two cell types in every animal (log2 FC).</li>
</ul>
</div>
</div>
<div id="randomized-complete-block-analysis" class="section level2">
<h2><span class="header-section-number">3.4</span> Randomized complete block analysis</h2>
<p>We can also analyse the design using a linear model with a main effect for cell type and a main effect for the block factor mouse. Because we have measured the two cell types in every mouse, we can estimate the average log2-intensity of the protein in the T-cells for each mouse.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>lmRCB &lt;-<span class="st"> </span><span class="kw">lm</span>(intensity <span class="op">~</span><span class="st"> </span>celltype <span class="op">+</span><span class="st"> </span>mouse, mouse)</span>
<span id="cb26-2"><a href="#cb26-2"></a><span class="kw">plot</span>(lmRCB, <span class="dt">which =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>))</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-11-1.png" width="672" /><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-11-2.png" width="672" /><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-11-3.png" width="672" /></p>
<p>If you have doubts on the assumptions you can always simulate data from a model with similar effects as ours but where are distributional assumptions hold and compare the residual plots.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>design &lt;-<span class="st">  </span><span class="kw">model.matrix</span>(intensity <span class="op">~</span><span class="st"> </span>celltype <span class="op">+</span><span class="st"> </span>mouse, mouse) </span>
<span id="cb27-2"><a href="#cb27-2"></a>sigmaMouse &lt;-<span class="st"> </span><span class="kw">sqrt</span>(car<span class="op">::</span><span class="kw">Anova</span>(lmRCB, <span class="dt">type =</span> <span class="st">&quot;III&quot;</span>)[<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Sum Sq&quot;</span>]<span class="op">/</span>car<span class="op">::</span><span class="kw">Anova</span>(lmRCB, <span class="dt">type =</span> <span class="st">&quot;III&quot;</span>)[<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Df&quot;</span>]) </span>
<span id="cb27-3"><a href="#cb27-3"></a>betas &lt;-<span class="st"> </span>lmRCB<span class="op">$</span>coefficients</span>
<span id="cb27-4"><a href="#cb27-4"></a>nMouse &lt;-<span class="st"> </span>mouse<span class="op">$</span>mouse <span class="op">%&gt;%</span><span class="st"> </span>unique <span class="op">%&gt;%</span><span class="st"> </span>length</span>
<span id="cb27-5"><a href="#cb27-5"></a></span>
<span id="cb27-6"><a href="#cb27-6"></a><span class="kw">par</span>(<span class="dt">mfrow=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">3</span>))</span>
<span id="cb27-7"><a href="#cb27-7"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">9</span>)</span>
<span id="cb27-8"><a href="#cb27-8"></a>{</span>
<span id="cb27-9"><a href="#cb27-9"></a>    mouseEffect &lt;-<span class="st"> </span><span class="kw">rnorm</span>(nMouse, <span class="dt">sd =</span> sigmaMouse)</span>
<span id="cb27-10"><a href="#cb27-10"></a>    betasMouse &lt;-<span class="st"> </span>mouseEffect[<span class="op">-</span><span class="dv">1</span>]<span class="op">-</span>mouseEffect[<span class="dv">1</span>]</span>
<span id="cb27-11"><a href="#cb27-11"></a>    betas[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>)] &lt;-<span class="st"> </span>betasMouse </span>
<span id="cb27-12"><a href="#cb27-12"></a>    ysim &lt;-<span class="st"> </span>design <span class="op">%*%</span><span class="st"> </span>betas  <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(design),<span class="dt">sd=</span><span class="kw">sigma</span>(lmRCB))</span>
<span id="cb27-13"><a href="#cb27-13"></a>    <span class="kw">plot</span>(<span class="kw">lm</span>(ysim <span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span>design), <span class="dt">which =</span> <span class="dv">1</span>) </span>
<span id="cb27-14"><a href="#cb27-14"></a>}</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a>anovaRCB &lt;-<span class="st"> </span>car<span class="op">::</span><span class="kw">Anova</span>(lmRCB, <span class="dt">type =</span> <span class="st">&quot;III&quot;</span>)</span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="kw">summary</span>(lmRCB)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = intensity ~ celltype + mouse, data = mouse)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -0.2356 -0.1387  0.0000  0.1387  0.2356 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    9.3671     0.1981  47.277 6.00e-09 ***
## celltypeTreg   1.2029     0.1401   8.586 0.000137 ***
## mousem2        0.5055     0.2621   1.929 0.102036    
## mousem3        1.0255     0.2621   3.913 0.007869 ** 
## mousem4        0.8545     0.2621   3.260 0.017245 *  
## mousem5        0.7880     0.2621   3.006 0.023809 *  
## mousem6        2.1055     0.2621   8.033 0.000199 ***
## mousem7        2.4475     0.2621   9.338 8.55e-05 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.2621 on 6 degrees of freedom
## Multiple R-squared:  0.9717, Adjusted R-squared:  0.9388 
## F-statistic: 29.47 on 7 and 6 DF,  p-value: 0.000309</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="kw">t.test</span>(mouseWide<span class="op">$</span>delta)</span></code></pre></div>
<pre><code>## 
##  One Sample t-test
## 
## data:  mouseWide$delta
## t = 8.5858, df = 6, p-value = 0.0001372
## alternative hypothesis: true mean is not equal to 0
## 95 percent confidence interval:
##  0.8600472 1.5456671
## sample estimates:
## mean of x 
##  1.202857</code></pre>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a>anovaRCB</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Sum Sq"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["F value"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Pr(>F)"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"153.5485475","2":"1","3":"2235.15420","4":"6.002402e-09","_rn_":"(Intercept)"},{"1":"5.0640286","2":"1","3":"73.71535","4":"1.371937e-04","_rn_":"celltype"},{"1":"9.1065619","2":"6","3":"22.09352","4":"7.601249e-04","_rn_":"mouse"},{"1":"0.4121824","2":"6","3":"NA","4":"NA","_rn_":"Residuals"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Notice that</p>
<ol style="list-style-type: decimal">
<li><p>the estimate, se, t-test statistic and p-value for the celltype effect of interest is the same as in the paired t-test!</p></li>
<li><p>the anova analysis shows that we will model the total variability in the protein expression in T-cells using variability due to the cell type (CT), the variability from mouse to mouse (M) and residual variability (R) within mouse that we cannot explain. Indeed,</p></li>
</ol>
<p><span class="math display">\[
\begin{array}{lcl}
\text{SSTot} &amp;=&amp; \text{SSCT} + \text{SSM} + \text{SSR}\\
14.6 &amp;=&amp; 5.1 + 9.1 + 0.4
\end{array}
\]</span></p>
<p>So the celltype and the mouse effect explain respectively <span class="math display">\[
\begin{array}{ll}
\frac{\text{SSCT}}{\text{SSTot}}\times 100&amp;\frac{\text{SSM}}{\text{SSTot}}\times 100\\\\
34.7&amp;
62.4\\
\end{array}
\]</span></p>
<p>percent of the variability in the protein expression values and <span class="math display">\[ 
\frac{\text{RSS}}{\text{SSTot}} \times 100 = 2.8
\]</span> percent cannot be explained.</p>
<p>Note, that</p>
<ul>
<li>the variability from mouse to mouse is the largest source of variability in the model,</li>
<li>This variability can be estimated with the RCB design and</li>
<li>can thus be isolated from the residual variability</li>
<li>leading to a much higher precision on the estimate of the average log2 FC between regulatory and conventional T-cells that what would be obtained with a CRD!</li>
</ul>
<p>Note, that the RCB also has to sacrifise a number of degrees of freedom to estimate the mouse effect, here 6 DF.</p>
<p>Hence, the power gain of the RCB is a trade-off between the variability that can be explained by the block effect and the loss in DF.</p>
<p>If you remember the equation of variance covariance matrix of the parameter estimators <span class="math display">\[
\hat{\boldsymbol{\Sigma}}^2_{\hat{\boldsymbol{\beta}}}
=\left(\mathbf{X}^T\mathbf{X}\right)^{-1}\hat\sigma^2
\]</span></p>
<p>you can see that the randomized complete block will have an impact on</p>
<ul>
<li><span class="math inline">\(\left(\mathbf{X}^T\mathbf{X}\right)^{-1}\)</span> as well as</li>
<li>on <span class="math inline">\(\sigma^2\)</span> of the residuals!</li>
</ul>
<p>We were able to isolate the variance in expression between animals/blocks from our analysis! <span class="math inline">\(\rightarrow\)</span> this will reduce the variance of the residuals and will lead to power gain if the variability between mice/blocks is large.</p>
<p>Also note that,</p>
<p><span class="math display">\[
\hat\sigma^2 = \frac{\text{SSR}}{n-p} = \frac{SSTot - SSM - SSCT}{n-p} 
\]</span></p>
<ul>
<li>Hence, blocking is beneficial if the reduction in sum of squares of the residuals is large compared to the degrees of freedom that are sacrifised.</li>
<li>Thus if SSM can explain a large part of the total variability.</li>
</ul>
<p>Further, the degrees of freedom affect the t-distribution that is used for inference, which has broader tails if the residual degrees of freedom <span class="math inline">\(n-p\)</span> are getting smaller.</p>
</div>
</div>
<div id="power-gain-of-an-rcb-vs-crd" class="section level1">
<h1><span class="header-section-number">4</span> Power gain of an RCB vs CRD</h1>
<p>In this section we will subset the original data in two experiments:</p>
<ul>
<li>A randomized complete block design with three mice</li>
<li>A completely randomized design with six mice but where we only measure one cell type in each mouse.</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="kw">set.seed</span>(<span class="dv">859</span>)</span>
<span id="cb33-2"><a href="#cb33-2"></a>mRcb &lt;-<span class="st"> </span>mouse <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb33-3"><a href="#cb33-3"></a><span class="st">  </span><span class="kw">pull</span>(mouse) <span class="op">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4"></a><span class="st">  </span>unique <span class="op">%&gt;%</span></span>
<span id="cb33-5"><a href="#cb33-5"></a><span class="st">  </span><span class="kw">sample</span>(<span class="dt">size=</span><span class="dv">3</span>)</span>
<span id="cb33-6"><a href="#cb33-6"></a></span>
<span id="cb33-7"><a href="#cb33-7"></a>rcbSmall &lt;-<span class="st"> </span>mouse <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(mouse<span class="op">%in%</span>mRcb)</span>
<span id="cb33-8"><a href="#cb33-8"></a>rcbSmall</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["celltype"],"name":[1],"type":["chr"],"align":["left"]},{"label":["mouse"],"name":[2],"type":["chr"],"align":["left"]},{"label":["intensity"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"Tcon","2":"m2","3":"10.022"},{"1":"Tcon","2":"m3","3":"10.604"},{"1":"Tcon","2":"m7","3":"11.709"},{"1":"Treg","2":"m2","3":"10.926"},{"1":"Treg","2":"m3","3":"11.384"},{"1":"Treg","2":"m7","3":"13.123"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>mCrd &lt;-<span class="st"> </span>mouse <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="st">  </span><span class="kw">pull</span>(mouse) <span class="op">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="st">  </span>unique <span class="op">%&gt;%</span></span>
<span id="cb34-4"><a href="#cb34-4"></a><span class="st">  </span><span class="kw">sample</span>(<span class="dt">size=</span><span class="dv">6</span>)</span>
<span id="cb34-5"><a href="#cb34-5"></a></span>
<span id="cb34-6"><a href="#cb34-6"></a></span>
<span id="cb34-7"><a href="#cb34-7"></a>crdSmall &lt;-<span class="st"> </span></span>
<span id="cb34-8"><a href="#cb34-8"></a><span class="st">  </span><span class="kw">bind_rows</span>(</span>
<span id="cb34-9"><a href="#cb34-9"></a>    mouse <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb34-10"><a href="#cb34-10"></a><span class="st">      </span><span class="kw">filter</span>(mouse<span class="op">%in%</span>mCrd[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb34-11"><a href="#cb34-11"></a><span class="st">      </span><span class="kw">filter</span>(celltype<span class="op">==</span><span class="st">&quot;Tcon&quot;</span>),</span>
<span id="cb34-12"><a href="#cb34-12"></a>    mouse <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb34-13"><a href="#cb34-13"></a><span class="st">      </span><span class="kw">filter</span>(mouse<span class="op">%in%</span>mCrd[<span class="op">-</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)]) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb34-14"><a href="#cb34-14"></a><span class="st">      </span><span class="kw">filter</span>(celltype<span class="op">==</span><span class="st">&quot;Treg&quot;</span>))</span>
<span id="cb34-15"><a href="#cb34-15"></a>crdSmall</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["celltype"],"name":[1],"type":["chr"],"align":["left"]},{"label":["mouse"],"name":[2],"type":["chr"],"align":["left"]},{"label":["intensity"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"Tcon","2":"m2","3":"10.022"},{"1":"Tcon","2":"m4","3":"10.328"},{"1":"Tcon","2":"m6","3":"11.237"},{"1":"Treg","2":"m1","3":"10.470"},{"1":"Treg","2":"m3","3":"11.384"},{"1":"Treg","2":"m7","3":"13.123"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>So in both experiments we need to do six mass spectrometry runs.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a>lmCRDSmall &lt;-<span class="st"> </span><span class="kw">lm</span>(intensity <span class="op">~</span><span class="st"> </span>celltype, crdSmall)</span>
<span id="cb35-2"><a href="#cb35-2"></a><span class="kw">summary</span>(lmCRDSmall)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = intensity ~ celltype, data = crdSmall)
## 
## Residuals:
##      1      2      3      4      5      6 
## -0.507 -0.201  0.708 -1.189 -0.275  1.464 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   10.5290     0.6077  17.326 6.51e-05 ***
## celltypeTreg   1.1300     0.8594   1.315    0.259    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.053 on 4 degrees of freedom
## Multiple R-squared:  0.3018, Adjusted R-squared:  0.1272 
## F-statistic: 1.729 on 1 and 4 DF,  p-value: 0.2589</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a><span class="kw">anova</span>(lmCRDSmall)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Df"],"name":[1],"type":["int"],"align":["right"]},{"label":["Sum Sq"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Mean Sq"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["F value"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Pr(>F)"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"1.915350","3":"1.915350","4":"1.728906","5":"0.2588669","_rn_":"celltype"},{"1":"4","2":"4.431356","3":"1.107839","4":"NA","5":"NA","_rn_":"Residuals"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>lmRCBSmall &lt;-<span class="st"> </span><span class="kw">lm</span>(intensity <span class="op">~</span><span class="st"> </span>celltype <span class="op">+</span><span class="st"> </span>mouse, rcbSmall)</span>
<span id="cb38-2"><a href="#cb38-2"></a><span class="kw">anova</span>(lmRCBSmall)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Df"],"name":[1],"type":["int"],"align":["right"]},{"label":["Sum Sq"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Mean Sq"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["F value"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Pr(>F)"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"1.5996007","3":"1.59960067","4":"28.33525","5":"0.03352697","_rn_":"celltype"},{"1":"2","2":"4.0425653","3":"2.02128267","4":"35.80491","5":"0.02717029","_rn_":"mouse"},{"1":"2","2":"0.1129053","3":"0.05645267","4":"NA","5":"NA","_rn_":"Residuals"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="kw">summary</span>(lmRCBSmall)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = intensity ~ celltype + mouse, data = rcbSmall)
## 
## Residuals:
##        1        2        3        4        5        6 
##  0.06433  0.12633 -0.19067 -0.06433 -0.12633  0.19067 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    9.9577     0.1940  51.329 0.000379 ***
## celltypeTreg   1.0327     0.1940   5.323 0.033527 *  
## mousem3        0.5200     0.2376   2.189 0.160094    
## mousem7        1.9420     0.2376   8.173 0.014641 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.2376 on 2 degrees of freedom
## Multiple R-squared:  0.9804, Adjusted R-squared:  0.951 
## F-statistic: 33.32 on 3 and 2 DF,  p-value: 0.02928</code></pre>
<p>Note, that</p>
<ul>
<li>we are able to pick up the upregulation between regulatory T-cells and ordinary T-cells with the RCB but not with the CRD.</li>
<li>the standard error of the <span class="math inline">\(\log_2\text{FC}_\text{Treg-Tcon}\)</span> estimate is a factor 4.4 smaller for the RCB design!</li>
</ul>
<p>A good biologists who knows about blocking but who is a poor data analist who forgets about the blocking will be back at square one:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a>wrongRbc &lt;-<span class="st"> </span><span class="kw">lm</span>(intensity <span class="op">~</span><span class="st"> </span>celltype, rcbSmall)</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="kw">anova</span>(wrongRbc)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Df"],"name":[1],"type":["int"],"align":["right"]},{"label":["Sum Sq"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["Mean Sq"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["F value"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["Pr(>F)"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"1","2":"1.599601","3":"1.599601","4":"1.539754","5":"0.2824583","_rn_":"celltype"},{"1":"4","2":"4.155471","3":"1.038868","4":"NA","5":"NA","_rn_":"Residuals"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a><span class="kw">summary</span>(wrongRbc)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = intensity ~ celltype, data = rcbSmall)
## 
## Residuals:
##       1       2       3       4       5       6 
## -0.7563 -0.1743  0.9307 -0.8850 -0.4270  1.3120 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   10.7783     0.5885  18.316 5.23e-05 ***
## celltypeTreg   1.0327     0.8322   1.241    0.282    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 1.019 on 4 degrees of freedom
## Multiple R-squared:  0.2779, Adjusted R-squared:  0.09743 
## F-statistic:  1.54 on 1 and 4 DF,  p-value: 0.2825</code></pre>
<p>So, we see that the block to block variability is then absorbed again in the variance estimator of the residual.</p>
<p>Of course, we are never allowed to analyse an RCB with a model for a CRD (without block factor) because blocking imposes a randomisation restriction: we randomize the treatment within block.</p>
<div id="powergain-of-blocking" class="section level2">
<h2><span class="header-section-number">4.1</span> Powergain of blocking?</h2>
<div id="power-for-completely-randomized-design" class="section level3">
<h3><span class="header-section-number">4.1.1</span> Power for completely randomized design</h3>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>varBetweenPlusWithin &lt;-<span class="st"> </span><span class="kw">sum</span>(car<span class="op">::</span><span class="kw">Anova</span>(lmRCB,<span class="dt">type=</span><span class="st">&quot;III&quot;</span>)[<span class="kw">c</span>(<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Residuals&quot;</span>),<span class="st">&quot;Sum Sq&quot;</span>])<span class="op">/</span><span class="kw">sum</span>(car<span class="op">::</span><span class="kw">Anova</span>(lmRCB,<span class="dt">type=</span><span class="st">&quot;III&quot;</span>)[<span class="kw">c</span>(<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Residuals&quot;</span>),<span class="st">&quot;Df&quot;</span>])</span>
<span id="cb44-2"><a href="#cb44-2"></a></span>
<span id="cb44-3"><a href="#cb44-3"></a>alpha &lt;-<span class="st"> </span><span class="fl">0.05</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>nSim &lt;-<span class="st"> </span><span class="dv">20000</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>b0 &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>sd &lt;-<span class="st"> </span><span class="kw">sqrt</span>(varBetweenPlusWithin)</span>
<span id="cb44-7"><a href="#cb44-7"></a>ns &lt;-<span class="st">  </span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>)  </span>
<span id="cb44-8"><a href="#cb44-8"></a>deltas &lt;-<span class="st"> </span>lmRCB<span class="op">$</span>coefficients[<span class="st">&quot;celltypeTreg&quot;</span>]</span>
<span id="cb44-9"><a href="#cb44-9"></a></span>
<span id="cb44-10"><a href="#cb44-10"></a>L &lt;-<span class="st"> </span>limma<span class="op">::</span><span class="kw">makeContrasts</span>(<span class="st">&quot;celltypeTreg&quot;</span>,<span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&quot;(Intercept)&quot;</span>,<span class="st">&quot;celltypeTreg&quot;</span>))</span></code></pre></div>
<pre><code>## Warning in limma::makeContrasts(&quot;celltypeTreg&quot;, levels = c(&quot;(Intercept)&quot;, :
## Renaming (Intercept) to Intercept</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>powerFast &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dt">nrow=</span><span class="kw">length</span>(ns)<span class="op">*</span><span class="kw">length</span>(deltas),<span class="dt">ncol=</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.data.frame</span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="kw">names</span>(powerFast) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;b1&quot;</span>,<span class="st">&quot;n&quot;</span>,<span class="st">&quot;power&quot;</span>)</span>
<span id="cb46-3"><a href="#cb46-3"></a></span>
<span id="cb46-4"><a href="#cb46-4"></a>i &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="cf">for</span> (n <span class="cf">in</span> ns)</span>
<span id="cb46-6"><a href="#cb46-6"></a>{</span>
<span id="cb46-7"><a href="#cb46-7"></a>  n1 &lt;-<span class="st"> </span>n2 &lt;-<span class="st">  </span>n</span>
<span id="cb46-8"><a href="#cb46-8"></a>  </span>
<span id="cb46-9"><a href="#cb46-9"></a>  <span class="co">### Simulation</span></span>
<span id="cb46-10"><a href="#cb46-10"></a>  predictorData &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">celltype =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Tcon&quot;</span>,<span class="st">&quot;Treg&quot;</span>),<span class="kw">c</span>(n1,n2)) <span class="op">%&gt;%</span><span class="st"> </span>as.factor)</span>
<span id="cb46-11"><a href="#cb46-11"></a>  design &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>celltype,predictorData)</span>
<span id="cb46-12"><a href="#cb46-12"></a>  </span>
<span id="cb46-13"><a href="#cb46-13"></a>  <span class="cf">for</span> (b1 <span class="cf">in</span> deltas)</span>
<span id="cb46-14"><a href="#cb46-14"></a>  {</span>
<span id="cb46-15"><a href="#cb46-15"></a>    ySim &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(predictorData)<span class="op">*</span>nSim,<span class="dt">sd=</span>sd)</span>
<span id="cb46-16"><a href="#cb46-16"></a>    <span class="kw">dim</span>(ySim) &lt;-<span class="kw">c</span>(<span class="kw">nrow</span>(predictorData),nSim)</span>
<span id="cb46-17"><a href="#cb46-17"></a>    ySim &lt;-<span class="st"> </span>ySim <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(design <span class="op">%*%</span><span class="kw">c</span>(b0,b1))</span>
<span id="cb46-18"><a href="#cb46-18"></a>    ySim &lt;-<span class="st"> </span><span class="kw">t</span>(ySim)</span>
<span id="cb46-19"><a href="#cb46-19"></a>  </span>
<span id="cb46-20"><a href="#cb46-20"></a>    <span class="co">### Fitting</span></span>
<span id="cb46-21"><a href="#cb46-21"></a>    fitAll &lt;-<span class="st"> </span>limma<span class="op">::</span><span class="kw">lmFit</span>(ySim,design)</span>
<span id="cb46-22"><a href="#cb46-22"></a>  </span>
<span id="cb46-23"><a href="#cb46-23"></a>    <span class="co">### Inference</span></span>
<span id="cb46-24"><a href="#cb46-24"></a>    varUnscaled &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">t</span>(L)<span class="op">%*%</span>fitAll<span class="op">$</span>cov.coefficients<span class="op">%*%</span>L)</span>
<span id="cb46-25"><a href="#cb46-25"></a>    contrasts &lt;-<span class="st"> </span>fitAll<span class="op">$</span>coefficients <span class="op">%*%</span>L</span>
<span id="cb46-26"><a href="#cb46-26"></a>    seContrasts &lt;-<span class="st"> </span>varUnscaled<span class="op">^</span>.<span class="dv">5</span><span class="op">*</span>fitAll<span class="op">$</span>sigma</span>
<span id="cb46-27"><a href="#cb46-27"></a>    tstats &lt;-<span class="st"> </span>contrasts<span class="op">/</span>seContrasts</span>
<span id="cb46-28"><a href="#cb46-28"></a>    pvals &lt;-<span class="st"> </span><span class="kw">pt</span>(<span class="kw">abs</span>(tstats),fitAll<span class="op">$</span>df.residual,<span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)<span class="op">*</span><span class="dv">2</span></span>
<span id="cb46-29"><a href="#cb46-29"></a>    </span>
<span id="cb46-30"><a href="#cb46-30"></a>    i &lt;-<span class="st"> </span>i<span class="op">+</span><span class="dv">1</span></span>
<span id="cb46-31"><a href="#cb46-31"></a>    powerFast[i,] &lt;-<span class="st"> </span><span class="kw">c</span>(b1,n,<span class="kw">mean</span>(pvals <span class="op">&lt;</span><span class="st"> </span>alpha))</span>
<span id="cb46-32"><a href="#cb46-32"></a>  }</span>
<span id="cb46-33"><a href="#cb46-33"></a>}</span>
<span id="cb46-34"><a href="#cb46-34"></a>powerFast</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["b1"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["power"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"1.202857","2":"3","3":"0.24675"},{"1":"1.202857","2":"7","3":"0.64355"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Because we have a simple 2 group comparison we can also calculate the power using the <code>power.t.test</code> function.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="kw">power.t.test</span>(<span class="dt">n =</span> <span class="dv">3</span>,<span class="dt">delta =</span> lmRCB<span class="op">$</span>coefficients[<span class="st">&quot;celltypeTreg&quot;</span>], <span class="dt">sd =</span> <span class="kw">sqrt</span>(varBetweenPlusWithin))</span></code></pre></div>
<pre><code>## 
##      Two-sample t test power calculation 
## 
##               n = 3
##           delta = 1.202857
##              sd = 0.8906339
##       sig.level = 0.05
##           power = 0.2477638
##     alternative = two.sided
## 
## NOTE: n is number in *each* group</code></pre>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="kw">power.t.test</span>(<span class="dt">n =</span> <span class="dv">7</span>,<span class="dt">delta =</span> lmRCB<span class="op">$</span>coefficients[<span class="st">&quot;celltypeTreg&quot;</span>], <span class="dt">sd =</span> <span class="kw">sqrt</span>(varBetweenPlusWithin))</span></code></pre></div>
<pre><code>## 
##      Two-sample t test power calculation 
## 
##               n = 7
##           delta = 1.202857
##              sd = 0.8906339
##       sig.level = 0.05
##           power = 0.6411438
##     alternative = two.sided
## 
## NOTE: n is number in *each* group</code></pre>
</div>
</div>
<div id="power-for-randomized-complete-block-design" class="section level2">
<h2><span class="header-section-number">4.2</span> Power for randomized complete block design</h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a>alpha &lt;-<span class="st"> </span><span class="fl">0.05</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>nSim &lt;-<span class="st"> </span><span class="dv">20000</span></span>
<span id="cb51-3"><a href="#cb51-3"></a>b0 &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb51-4"><a href="#cb51-4"></a>sd &lt;-<span class="st"> </span><span class="kw">sigma</span>(lmRCB)</span>
<span id="cb51-5"><a href="#cb51-5"></a>sdMouse&lt;-<span class="st"> </span><span class="kw">sqrt</span>(car<span class="op">::</span><span class="kw">Anova</span>(lmRCB)[<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Sum Sq&quot;</span>]<span class="op">/</span>car<span class="op">::</span><span class="kw">Anova</span>(lmRCB)[<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Df&quot;</span>]) </span>
<span id="cb51-6"><a href="#cb51-6"></a>ns &lt;-<span class="st">  </span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>)  </span>
<span id="cb51-7"><a href="#cb51-7"></a>deltas &lt;-<span class="st"> </span>lmRCB<span class="op">$</span>coefficients[<span class="st">&quot;celltypeTreg&quot;</span>]</span>
<span id="cb51-8"><a href="#cb51-8"></a></span>
<span id="cb51-9"><a href="#cb51-9"></a></span>
<span id="cb51-10"><a href="#cb51-10"></a>powerFastBlocking &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dt">nrow=</span><span class="kw">length</span>(ns)<span class="op">*</span><span class="kw">length</span>(deltas),<span class="dt">ncol=</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.data.frame</span>
<span id="cb51-11"><a href="#cb51-11"></a><span class="kw">names</span>(powerFastBlocking) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;b1&quot;</span>,<span class="st">&quot;n&quot;</span>,<span class="st">&quot;power&quot;</span>)</span>
<span id="cb51-12"><a href="#cb51-12"></a></span>
<span id="cb51-13"><a href="#cb51-13"></a>i &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb51-14"><a href="#cb51-14"></a><span class="cf">for</span> (n <span class="cf">in</span> ns)</span>
<span id="cb51-15"><a href="#cb51-15"></a>{</span>
<span id="cb51-16"><a href="#cb51-16"></a>  </span>
<span id="cb51-17"><a href="#cb51-17"></a>  <span class="co">### Simulation</span></span>
<span id="cb51-18"><a href="#cb51-18"></a>  predictorData &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">celltype =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Tcon&quot;</span>,<span class="st">&quot;Treg&quot;</span>),<span class="dt">each=</span>n) <span class="op">%&gt;%</span><span class="st"> </span>as.factor, <span class="dt">mouse =</span> <span class="kw">paste0</span>(<span class="st">&quot;m&quot;</span>,<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>n,<span class="dv">2</span>)))</span>
<span id="cb51-19"><a href="#cb51-19"></a>  design &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span><span class="st"> </span>celltype <span class="op">+</span><span class="st"> </span>mouse,predictorData)</span>
<span id="cb51-20"><a href="#cb51-20"></a>  L &lt;-<span class="st"> </span>limma<span class="op">::</span><span class="kw">makeContrasts</span>(<span class="st">&quot;celltypeTreg&quot;</span>,<span class="dt">levels=</span><span class="kw">colnames</span>(design))</span>
<span id="cb51-21"><a href="#cb51-21"></a></span>
<span id="cb51-22"><a href="#cb51-22"></a>  <span class="cf">for</span> (b1 <span class="cf">in</span> deltas)</span>
<span id="cb51-23"><a href="#cb51-23"></a>  {</span>
<span id="cb51-24"><a href="#cb51-24"></a>    ySim &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(predictorData)<span class="op">*</span>nSim,<span class="dt">sd=</span>sd)</span>
<span id="cb51-25"><a href="#cb51-25"></a>    <span class="kw">dim</span>(ySim) &lt;-<span class="kw">c</span>(<span class="kw">nrow</span>(predictorData),nSim)</span>
<span id="cb51-26"><a href="#cb51-26"></a>    mouseEffect &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dt">sd =</span> sdMouse)</span>
<span id="cb51-27"><a href="#cb51-27"></a>    betasMouse &lt;-<span class="st"> </span>mouseEffect[<span class="op">-</span><span class="dv">1</span>]<span class="op">-</span>mouseEffect[<span class="dv">1</span>]</span>
<span id="cb51-28"><a href="#cb51-28"></a>    ySim &lt;-<span class="st"> </span>ySim <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(design <span class="op">%*%</span><span class="kw">c</span>(b0,b1,betasMouse))</span>
<span id="cb51-29"><a href="#cb51-29"></a>    ySim &lt;-<span class="st"> </span><span class="kw">t</span>(ySim)</span>
<span id="cb51-30"><a href="#cb51-30"></a>  </span>
<span id="cb51-31"><a href="#cb51-31"></a>    <span class="co">### Fitting</span></span>
<span id="cb51-32"><a href="#cb51-32"></a>    fitAll &lt;-<span class="st"> </span>limma<span class="op">::</span><span class="kw">lmFit</span>(ySim,design)</span>
<span id="cb51-33"><a href="#cb51-33"></a>  </span>
<span id="cb51-34"><a href="#cb51-34"></a>    <span class="co">### Inference</span></span>
<span id="cb51-35"><a href="#cb51-35"></a>    varUnscaled &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">t</span>(L)<span class="op">%*%</span>fitAll<span class="op">$</span>cov.coefficients<span class="op">%*%</span>L)</span>
<span id="cb51-36"><a href="#cb51-36"></a>    contrasts &lt;-<span class="st"> </span>fitAll<span class="op">$</span>coefficients <span class="op">%*%</span>L</span>
<span id="cb51-37"><a href="#cb51-37"></a>    seContrasts &lt;-<span class="st"> </span>varUnscaled<span class="op">^</span>.<span class="dv">5</span><span class="op">*</span>fitAll<span class="op">$</span>sigma</span>
<span id="cb51-38"><a href="#cb51-38"></a>    tstats &lt;-<span class="st"> </span>contrasts<span class="op">/</span>seContrasts</span>
<span id="cb51-39"><a href="#cb51-39"></a>    pvals &lt;-<span class="st"> </span><span class="kw">pt</span>(<span class="kw">abs</span>(tstats),fitAll<span class="op">$</span>df.residual,<span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)<span class="op">*</span><span class="dv">2</span></span>
<span id="cb51-40"><a href="#cb51-40"></a>    </span>
<span id="cb51-41"><a href="#cb51-41"></a>    i &lt;-<span class="st"> </span>i<span class="op">+</span><span class="dv">1</span></span>
<span id="cb51-42"><a href="#cb51-42"></a>    powerFastBlocking[i,] &lt;-<span class="st"> </span><span class="kw">c</span>(b1,n,<span class="kw">mean</span>(pvals <span class="op">&lt;</span><span class="st"> </span>alpha))</span>
<span id="cb51-43"><a href="#cb51-43"></a>  }</span>
<span id="cb51-44"><a href="#cb51-44"></a>}</span></code></pre></div>
<pre><code>## Warning in limma::makeContrasts(&quot;celltypeTreg&quot;, levels = colnames(design)):
## Renaming (Intercept) to Intercept

## Warning in limma::makeContrasts(&quot;celltypeTreg&quot;, levels = colnames(design)):
## Renaming (Intercept) to Intercept</code></pre>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1"></a>powerFastBlocking</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["b1"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["power"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"1.202857","2":"3","3":"0.79505"},{"1":"1.202857","2":"7","3":"1.00000"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>Because we have an RCB with a block size of 2 (paired design) we can also calculate the power using the <code>power.t.test function</code> with <code>type = "one.sample"</code> and <code>sd</code> equal to the standard deviation of the difference.</p>
<p>Note, that the power is indeed much larger for the randomized complete block design. Both for the designs with 6 and 14 mass spectrometer runs have to be done.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1"></a><span class="kw">power.t.test</span>(<span class="dt">n =</span> <span class="dv">3</span>,<span class="dt">delta =</span> <span class="kw">mean</span>(mouseWide<span class="op">$</span>delta), <span class="dt">sd =</span> <span class="kw">sd</span>(mouseWide<span class="op">$</span>delta))</span></code></pre></div>
<pre><code>## 
##      Two-sample t test power calculation 
## 
##               n = 3
##           delta = 1.202857
##              sd = 0.3706672
##       sig.level = 0.05
##           power = 0.8389961
##     alternative = two.sided
## 
## NOTE: n is number in *each* group</code></pre>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1"></a><span class="kw">power.t.test</span>(<span class="dt">n =</span> <span class="dv">7</span>,<span class="dt">delta =</span> <span class="kw">mean</span>(mouseWide<span class="op">$</span>delta), <span class="dt">sd =</span> <span class="kw">sd</span>(mouseWide<span class="op">$</span>delta))</span></code></pre></div>
<pre><code>## 
##      Two-sample t test power calculation 
## 
##               n = 7
##           delta = 1.202857
##              sd = 0.3706672
##       sig.level = 0.05
##           power = 0.999826
##     alternative = two.sided
## 
## NOTE: n is number in *each* group</code></pre>
<p>Note, that the power is slightly different because for the power.t.test function we conditioned on the mice from our study.</p>
<p>In the simulation study we generated data for new mice by simulting the mouse effect from a normal distribution.</p>
</div>
<div id="impact-of-the-amount-of-variability-of-the-blocking-factor-on-the-power" class="section level2">
<h2><span class="header-section-number">4.3</span> Impact of the amount of variability of the blocking factor on the power?</h2>
<p>We will vary <span class="math display">\[
\frac{\sigma^2_\text{between}}{\sigma^2_\text{between}+\sigma^2_\text{within}}=1-\frac{\sigma^2_\text{within}}{\sigma^2_\text{between}+\sigma^2_\text{within}}
\]</span> So in our example that is the ratio between the variability between the rats and the sum of the variability between and within the rats. Note, that the latter was the variance of the errors of the RCB and equals</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1"></a>varBetweenPlusWithin &lt;-<span class="st"> </span><span class="kw">sum</span>(car<span class="op">::</span><span class="kw">Anova</span>(lmRCB,<span class="dt">type=</span><span class="st">&quot;III&quot;</span>)[<span class="kw">c</span>(<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Residuals&quot;</span>),<span class="st">&quot;Sum Sq&quot;</span>])<span class="op">/</span><span class="kw">sum</span>(car<span class="op">::</span><span class="kw">Anova</span>(lmRCB,<span class="dt">type=</span><span class="st">&quot;III&quot;</span>)[<span class="kw">c</span>(<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Residuals&quot;</span>),<span class="st">&quot;Df&quot;</span>])</span>
<span id="cb58-2"><a href="#cb58-2"></a>varWithin &lt;-<span class="st"> </span>car<span class="op">::</span><span class="kw">Anova</span>(lmRCB)[<span class="st">&quot;Residuals&quot;</span>,<span class="st">&quot;Sum Sq&quot;</span>]<span class="op">/</span>car<span class="op">::</span><span class="kw">Anova</span>(lmRCB)[<span class="st">&quot;Residuals&quot;</span>,<span class="st">&quot;Df&quot;</span>]</span>
<span id="cb58-3"><a href="#cb58-3"></a>varBetweenPlusWithin</span></code></pre></div>
<pre><code>## [1] 0.7932287</code></pre>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1"></a>varWithin</span></code></pre></div>
<pre><code>## [1] 0.06869707</code></pre>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1"></a><span class="dv">1</span><span class="op">-</span><span class="st"> </span>varWithin<span class="op">/</span>varBetweenPlusWithin</span></code></pre></div>
<pre><code>## [1] 0.9133956</code></pre>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1"></a>alpha &lt;-<span class="st"> </span><span class="fl">0.05</span></span>
<span id="cb64-2"><a href="#cb64-2"></a>nSim &lt;-<span class="st"> </span><span class="dv">20000</span></span>
<span id="cb64-3"><a href="#cb64-3"></a>b0 &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb64-4"><a href="#cb64-4"></a>varBetweenPlusWithin &lt;-<span class="st"> </span><span class="kw">sum</span>(car<span class="op">::</span><span class="kw">Anova</span>(lmRCB,<span class="dt">type=</span><span class="st">&quot;III&quot;</span>)[<span class="kw">c</span>(<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Residuals&quot;</span>),<span class="st">&quot;Sum Sq&quot;</span>])<span class="op">/</span><span class="kw">sum</span>(car<span class="op">::</span><span class="kw">Anova</span>(lmRCB,<span class="dt">type=</span><span class="st">&quot;III&quot;</span>)[<span class="kw">c</span>(<span class="st">&quot;mouse&quot;</span>,<span class="st">&quot;Residuals&quot;</span>),<span class="st">&quot;Df&quot;</span>])</span>
<span id="cb64-5"><a href="#cb64-5"></a> </span>
<span id="cb64-6"><a href="#cb64-6"></a></span>
<span id="cb64-7"><a href="#cb64-7"></a>ns &lt;-<span class="st">  </span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">7</span>)  </span>
<span id="cb64-8"><a href="#cb64-8"></a>deltas &lt;-<span class="st"> </span>lmRCB<span class="op">$</span>coefficients[<span class="st">&quot;celltypeTreg&quot;</span>]</span>
<span id="cb64-9"><a href="#cb64-9"></a></span>
<span id="cb64-10"><a href="#cb64-10"></a>fracVars &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>,.<span class="dv">95</span>,.<span class="dv">05</span>)</span>
<span id="cb64-11"><a href="#cb64-11"></a></span>
<span id="cb64-12"><a href="#cb64-12"></a>powerFastBlockingLow &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,<span class="dt">nrow=</span><span class="kw">length</span>(ns)<span class="op">*</span><span class="kw">length</span>(fracVars),<span class="dt">ncol=</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.data.frame</span>
<span id="cb64-13"><a href="#cb64-13"></a><span class="kw">names</span>(powerFastBlockingLow) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;fracVars&quot;</span>,<span class="st">&quot;n&quot;</span>,<span class="st">&quot;power&quot;</span>)</span>
<span id="cb64-14"><a href="#cb64-14"></a></span>
<span id="cb64-15"><a href="#cb64-15"></a>i &lt;-<span class="st"> </span><span class="dv">0</span></span>
<span id="cb64-16"><a href="#cb64-16"></a></span>
<span id="cb64-17"><a href="#cb64-17"></a></span>
<span id="cb64-18"><a href="#cb64-18"></a><span class="cf">for</span> (n <span class="cf">in</span> ns)</span>
<span id="cb64-19"><a href="#cb64-19"></a>{</span>
<span id="cb64-20"><a href="#cb64-20"></a>  </span>
<span id="cb64-21"><a href="#cb64-21"></a>  <span class="co">### Simulation</span></span>
<span id="cb64-22"><a href="#cb64-22"></a>  predictorData &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">celltype =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;Tcon&quot;</span>,<span class="st">&quot;Treg&quot;</span>),<span class="dt">each=</span>n) <span class="op">%&gt;%</span><span class="st"> </span>as.factor, <span class="dt">mouse =</span> <span class="kw">paste0</span>(<span class="st">&quot;m&quot;</span>,<span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span>n,<span class="dv">2</span>)))</span>
<span id="cb64-23"><a href="#cb64-23"></a>  design &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span><span class="st"> </span>celltype <span class="op">+</span><span class="st"> </span>mouse,predictorData)</span>
<span id="cb64-24"><a href="#cb64-24"></a>  L &lt;-<span class="st"> </span>limma<span class="op">::</span><span class="kw">makeContrasts</span>(<span class="st">&quot;celltypeTreg&quot;</span>,<span class="dt">levels=</span><span class="kw">colnames</span>(design))</span>
<span id="cb64-25"><a href="#cb64-25"></a>  <span class="cf">for</span> (fracVar <span class="cf">in</span> fracVars)</span>
<span id="cb64-26"><a href="#cb64-26"></a>  {</span>
<span id="cb64-27"><a href="#cb64-27"></a>  sd &lt;-<span class="st"> </span><span class="kw">sqrt</span>(varBetweenPlusWithin<span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>fracVar))</span>
<span id="cb64-28"><a href="#cb64-28"></a>  sdMouse &lt;-<span class="st"> </span><span class="kw">sqrt</span>(varBetweenPlusWithin<span class="op">*</span>fracVar) </span>
<span id="cb64-29"><a href="#cb64-29"></a>  <span class="cf">for</span> (b1 <span class="cf">in</span> deltas)</span>
<span id="cb64-30"><a href="#cb64-30"></a>  {</span>
<span id="cb64-31"><a href="#cb64-31"></a>    ySim &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(predictorData)<span class="op">*</span>nSim,<span class="dt">sd=</span>sd)</span>
<span id="cb64-32"><a href="#cb64-32"></a>    <span class="kw">dim</span>(ySim) &lt;-<span class="kw">c</span>(<span class="kw">nrow</span>(predictorData),nSim)</span>
<span id="cb64-33"><a href="#cb64-33"></a>    mouseEffect &lt;-<span class="st"> </span><span class="kw">rnorm</span>(n, <span class="dt">sd =</span> sdMouse)</span>
<span id="cb64-34"><a href="#cb64-34"></a>    betasMouse &lt;-<span class="st"> </span>mouseEffect[<span class="op">-</span><span class="dv">1</span>]<span class="op">-</span>mouseEffect[<span class="dv">1</span>]</span>
<span id="cb64-35"><a href="#cb64-35"></a>    ySim &lt;-<span class="st"> </span>ySim <span class="op">+</span><span class="st"> </span><span class="kw">c</span>(design <span class="op">%*%</span><span class="kw">c</span>(b0,b1,betasMouse))</span>
<span id="cb64-36"><a href="#cb64-36"></a>    ySim &lt;-<span class="st"> </span><span class="kw">t</span>(ySim)</span>
<span id="cb64-37"><a href="#cb64-37"></a>  </span>
<span id="cb64-38"><a href="#cb64-38"></a>    <span class="co">### Fitting</span></span>
<span id="cb64-39"><a href="#cb64-39"></a>    fitAll &lt;-<span class="st"> </span>limma<span class="op">::</span><span class="kw">lmFit</span>(ySim,design)</span>
<span id="cb64-40"><a href="#cb64-40"></a>  </span>
<span id="cb64-41"><a href="#cb64-41"></a>    <span class="co">### Inference</span></span>
<span id="cb64-42"><a href="#cb64-42"></a>    varUnscaled &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">t</span>(L)<span class="op">%*%</span>fitAll<span class="op">$</span>cov.coefficients<span class="op">%*%</span>L)</span>
<span id="cb64-43"><a href="#cb64-43"></a>    contrasts &lt;-<span class="st"> </span>fitAll<span class="op">$</span>coefficients <span class="op">%*%</span>L</span>
<span id="cb64-44"><a href="#cb64-44"></a>    seContrasts &lt;-<span class="st"> </span>varUnscaled<span class="op">^</span>.<span class="dv">5</span><span class="op">*</span>fitAll<span class="op">$</span>sigma</span>
<span id="cb64-45"><a href="#cb64-45"></a>    tstats &lt;-<span class="st"> </span>contrasts<span class="op">/</span>seContrasts</span>
<span id="cb64-46"><a href="#cb64-46"></a>    pvals &lt;-<span class="st"> </span><span class="kw">pt</span>(<span class="kw">abs</span>(tstats),fitAll<span class="op">$</span>df.residual,<span class="dt">lower.tail =</span> <span class="ot">FALSE</span>)<span class="op">*</span><span class="dv">2</span></span>
<span id="cb64-47"><a href="#cb64-47"></a>    </span>
<span id="cb64-48"><a href="#cb64-48"></a>    i &lt;-<span class="st"> </span>i<span class="op">+</span><span class="dv">1</span></span>
<span id="cb64-49"><a href="#cb64-49"></a>    powerFastBlockingLow[i,] &lt;-<span class="st"> </span><span class="kw">c</span>(fracVar,n,<span class="kw">mean</span>(pvals <span class="op">&lt;</span><span class="st"> </span>alpha))</span>
<span id="cb64-50"><a href="#cb64-50"></a>  }</span>
<span id="cb64-51"><a href="#cb64-51"></a>  }</span>
<span id="cb64-52"><a href="#cb64-52"></a>}</span></code></pre></div>
<pre><code>## Warning in limma::makeContrasts(&quot;celltypeTreg&quot;, levels = colnames(design)):
## Renaming (Intercept) to Intercept

## Warning in limma::makeContrasts(&quot;celltypeTreg&quot;, levels = colnames(design)):
## Renaming (Intercept) to Intercept</code></pre>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1"></a>powerFastBlockingLow</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["fracVars"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["n"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["power"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"0.00","2":"3","3":"0.16935"},{"1":"0.05","2":"3","3":"0.17575"},{"1":"0.10","2":"3","3":"0.18705"},{"1":"0.15","2":"3","3":"0.19050"},{"1":"0.20","2":"3","3":"0.19445"},{"1":"0.25","2":"3","3":"0.20330"},{"1":"0.30","2":"3","3":"0.20745"},{"1":"0.35","2":"3","3":"0.22805"},{"1":"0.40","2":"3","3":"0.24110"},{"1":"0.45","2":"3","3":"0.26075"},{"1":"0.50","2":"3","3":"0.27305"},{"1":"0.55","2":"3","3":"0.29500"},{"1":"0.60","2":"3","3":"0.31615"},{"1":"0.65","2":"3","3":"0.34370"},{"1":"0.70","2":"3","3":"0.38995"},{"1":"0.75","2":"3","3":"0.44120"},{"1":"0.80","2":"3","3":"0.51210"},{"1":"0.85","2":"3","3":"0.60890"},{"1":"0.90","2":"3","3":"0.75210"},{"1":"0.95","2":"3","3":"0.93550"},{"1":"0.00","2":"7","3":"0.55920"},{"1":"0.05","2":"7","3":"0.58150"},{"1":"0.10","2":"7","3":"0.60545"},{"1":"0.15","2":"7","3":"0.62625"},{"1":"0.20","2":"7","3":"0.65755"},{"1":"0.25","2":"7","3":"0.68370"},{"1":"0.30","2":"7","3":"0.71110"},{"1":"0.35","2":"7","3":"0.73940"},{"1":"0.40","2":"7","3":"0.77070"},{"1":"0.45","2":"7","3":"0.80430"},{"1":"0.50","2":"7","3":"0.85040"},{"1":"0.55","2":"7","3":"0.88100"},{"1":"0.60","2":"7","3":"0.90875"},{"1":"0.65","2":"7","3":"0.94025"},{"1":"0.70","2":"7","3":"0.96775"},{"1":"0.75","2":"7","3":"0.98600"},{"1":"0.80","2":"7","3":"0.99525"},{"1":"0.85","2":"7","3":"0.99955"},{"1":"0.90","2":"7","3":"1.00000"},{"1":"0.95","2":"7","3":"1.00000"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1"></a>gg_color_hue &lt;-<span class="st"> </span><span class="cf">function</span>(n) {</span>
<span id="cb67-2"><a href="#cb67-2"></a>  hues =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">15</span>, <span class="dv">375</span>, <span class="dt">length =</span> n <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</span>
<span id="cb67-3"><a href="#cb67-3"></a>  <span class="kw">hcl</span>(<span class="dt">h =</span> hues, <span class="dt">l =</span> <span class="dv">65</span>, <span class="dt">c =</span> <span class="dv">100</span>)[<span class="dv">1</span><span class="op">:</span>n]</span>
<span id="cb67-4"><a href="#cb67-4"></a>}</span>
<span id="cb67-5"><a href="#cb67-5"></a>cols &lt;-<span class="st"> </span><span class="kw">gg_color_hue</span>(<span class="dv">2</span>)</span>
<span id="cb67-6"><a href="#cb67-6"></a></span>
<span id="cb67-7"><a href="#cb67-7"></a>powerFastBlockingLow <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb67-8"><a href="#cb67-8"></a><span class="st">  </span>as.data.frame <span class="op">%&gt;%</span></span>
<span id="cb67-9"><a href="#cb67-9"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">n =</span> <span class="kw">as.factor</span>(n)) <span class="op">%&gt;%</span></span>
<span id="cb67-10"><a href="#cb67-10"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(fracVars,power,<span class="dt">group=</span>n,<span class="dt">color=</span>n)) <span class="op">+</span></span>
<span id="cb67-11"><a href="#cb67-11"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb67-12"><a href="#cb67-12"></a><span class="st">  </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> powerFast <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(n<span class="op">==</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(power),<span class="dt">color=</span>cols[<span class="dv">1</span>]) <span class="op">+</span></span>
<span id="cb67-13"><a href="#cb67-13"></a><span class="st">  </span><span class="kw">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="dt">label =</span> <span class="st">&quot;CRD (n=3)&quot;</span>,</span>
<span id="cb67-14"><a href="#cb67-14"></a>    <span class="dt">x =</span> <span class="fl">0.05</span>, <span class="dt">y =</span> powerFast <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(n<span class="op">==</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(power) <span class="fl">+.02</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">colour =</span> cols[<span class="dv">1</span>]) <span class="op">+</span></span>
<span id="cb67-15"><a href="#cb67-15"></a><span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> powerFast <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(n<span class="op">==</span><span class="dv">7</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(power),<span class="dt">color=</span>cols[<span class="dv">2</span>]) <span class="op">+</span></span>
<span id="cb67-16"><a href="#cb67-16"></a><span class="st">    </span><span class="kw">annotate</span>(<span class="st">&quot;text&quot;</span>, <span class="dt">label =</span> <span class="st">&quot;CRD (n=7)&quot;</span>,</span>
<span id="cb67-17"><a href="#cb67-17"></a>    <span class="dt">x =</span> <span class="fl">0.05</span>, <span class="dt">y =</span> powerFast <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(n<span class="op">==</span><span class="dv">7</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(power) <span class="fl">+.02</span>, <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">colour =</span> cols[<span class="dv">2</span>]) <span class="op">+</span></span>
<span id="cb67-18"><a href="#cb67-18"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="kw">expression</span>(<span class="op">~</span>sigma[between]<span class="op">^</span><span class="dv">2</span><span class="op">/</span>(sigma[between]<span class="op">^</span><span class="dv">2</span><span class="op">+</span>sigma[within]<span class="op">^</span><span class="dv">2</span>))) <span class="op">+</span></span>
<span id="cb67-19"><a href="#cb67-19"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">1</span><span class="op">-</span>varWithin<span class="op">/</span>varBetweenPlusWithin) <span class="op">+</span></span>
<span id="cb67-20"><a href="#cb67-20"></a><span class="st">  </span><span class="kw">xlim</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<ul>
<li>So if the variance that is explained by the block effect is small you will loose power as compared to the analysis with a CRD design.</li>
<li>As soon as the block effect explains a large part of the variability it is very beneficial to use a randomized complete block design!</li>
<li>Note, that the same number of mass spectrometry runs have to be done for both RCB and CRD design. However, for the RCB we only need half of the rats and we have a much higher power for this study!</li>
</ul>
</div>
</div>
<div id="penilin-example" class="section level1">
<h1><span class="header-section-number">5</span> Penilin example</h1>
<p>The production of penicillin corn steep liquor is used. Corn steep liquor is produced in blends and there is a considerable variability between the blends. Suppose that</p>
<ul>
<li>four competing methods have to be evaluated to produce penicillin (A-D),</li>
<li>one blends is sufficient for four runs of a penicillin batch reactor and</li>
<li>the 20 runs can be scheduled for the experiment.</li>
</ul>
<p>How would you assign the methods to the blends.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1"></a><span class="kw">data</span>(penicillin, <span class="dt">package=</span><span class="st">&quot;faraway&quot;</span>)</span>
<span id="cb68-2"><a href="#cb68-2"></a><span class="kw">table</span>(penicillin<span class="op">$</span>blend,penicillin<span class="op">$</span>treat)</span></code></pre></div>
<pre><code>##         
##          A B C D
##   Blend1 1 1 1 1
##   Blend2 1 1 1 1
##   Blend3 1 1 1 1
##   Blend4 1 1 1 1
##   Blend5 1 1 1 1</code></pre>
<p>Data</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1"></a><span class="kw">head</span>(penicillin)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["treat"],"name":[1],"type":["fct"],"align":["left"]},{"label":["blend"],"name":[2],"type":["fct"],"align":["left"]},{"label":["yield"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"A","2":"Blend1","3":"89","_rn_":"1"},{"1":"B","2":"Blend1","3":"88","_rn_":"2"},{"1":"C","2":"Blend1","3":"97","_rn_":"3"},{"1":"D","2":"Blend1","3":"94","_rn_":"4"},{"1":"A","2":"Blend2","3":"84","_rn_":"5"},{"1":"B","2":"Blend2","3":"77","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1"></a><span class="kw">matrix</span>(penicillin<span class="op">$</span>yield,<span class="dt">nrow=</span><span class="dv">5</span>,<span class="dt">ncol=</span><span class="dv">4</span>,<span class="dt">byrow=</span><span class="ot">TRUE</span>,<span class="dt">dimnames=</span><span class="kw">list</span>(<span class="kw">levels</span>(penicillin<span class="op">$</span>blend),<span class="kw">levels</span>(penicillin<span class="op">$</span>treat)))</span></code></pre></div>
<pre><code>##         A  B  C  D
## Blend1 89 88 97 94
## Blend2 84 77 92 79
## Blend3 81 87 87 85
## Blend4 87 92 89 84
## Blend5 79 81 80 88</code></pre>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1"></a>penicillin <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb73-2"><a href="#cb73-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> blend, <span class="dt">y =</span> yield, <span class="dt">group =</span> treat, <span class="dt">color =</span> treat)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb73-3"><a href="#cb73-3"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb73-4"><a href="#cb73-4"></a><span class="st">  </span><span class="kw">geom_point</span>()</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1"></a>penicillin <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb74-2"><a href="#cb74-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> treat, <span class="dt">y =</span> yield, <span class="dt">group =</span> blend, <span class="dt">color =</span> blend)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb74-3"><a href="#cb74-3"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb74-4"><a href="#cb74-4"></a><span class="st">  </span><span class="kw">geom_point</span>()</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<div id="analysis" class="section level2">
<h2><span class="header-section-number">5.1</span> Analysis</h2>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1"></a>lmPen &lt;-<span class="st"> </span><span class="kw">lm</span>(yield<span class="op">~</span>treat <span class="op">+</span><span class="st"> </span>blend, <span class="dt">data =</span> penicillin)</span>
<span id="cb75-2"><a href="#cb75-2"></a><span class="kw">plot</span>(lmPen)</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-30-1.png" width="672" /><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-30-2.png" width="672" /><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-30-3.png" width="672" /><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-30-4.png" width="672" /></p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1"></a>car<span class="op">::</span><span class="kw">Anova</span>(lmPen,<span class="dt">type=</span><span class="st">&quot;III&quot;</span>)</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["Sum Sq"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["Df"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["F value"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["Pr(>F)"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"20250","2":"1","3":"1075.221239","4":"4.097853e-13","_rn_":"(Intercept)"},{"1":"70","2":"3","3":"1.238938","4":"3.386581e-01","_rn_":"treat"},{"1":"264","2":"4","3":"3.504425","4":"4.074617e-02","_rn_":"blend"},{"1":"226","2":"12","3":"NA","4":"NA","_rn_":"Residuals"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>We conclude that the effect of the treatment on the penicillin yield is not significant at the 5% level of significance (p = 0.34.</p>
<p>We also observe that there is a large effect of the blend on the yield. Blend explains about 47.1% of the variability in the penicillin yield.</p>
</div>
</div>
<div id="pseudo-replication" class="section level1">
<h1><span class="header-section-number">6</span> Pseudo-replication</h1>
<div id="background-1" class="section level2">
<h2><span class="header-section-number">6.1</span> Background</h2>
<p>A study on the facultative pathogen Francisella tularensis was conceived by Ramond et al. (2015) [12].</p>
<ul>
<li><p>F. tularensis enters the cells of its host by phagocytosis.</p></li>
<li><p>The authors showed that F. tularensis is arginine deficient and imports arginine from the host cell via an arginine transporter, ArgP, in order to efficiently escape from the phagosome and reach the cytosolic compartment, where it can actively multiply.</p></li>
<li><p>In their study, they compared the proteome of wild type F. tularensis (WT) to ArgP-gene deleted F. tularensis (knock-out, D8).</p></li>
<li><p>The sample for each bio-rep was run in technical triplicate on the mass-spectrometer.</p></li>
<li><p>We will use data for the protein 50S ribosomal protein L5 <a href="https://www.uniprot.org/uniprot/A0Q4J5">A0Q4J5</a></p></li>
</ul>
</div>
<div id="data-exploration-2" class="section level2">
<h2><span class="header-section-number">6.2</span> Data exploration</h2>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1"></a>franc &lt;-<span class="st"> </span><span class="kw">read_tsv</span>(<span class="st">&quot;https://raw.githubusercontent.com/statOmics/PSLS21/data/francisellaA0Q4J5.txt&quot;</span>)</span></code></pre></div>
<pre><code>## Rows: 18 Columns: 3</code></pre>
<pre><code>## ── Column specification ────────────────────────────────────────────────────────
## Delimiter: &quot;\t&quot;
## chr (2): genotype, biorep
## dbl (1): intensityLog2</code></pre>
<pre><code>## 
## ℹ Use `spec()` to retrieve the full column specification for this data.
## ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1"></a>franc</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["genotype"],"name":[1],"type":["chr"],"align":["left"]},{"label":["biorep"],"name":[2],"type":["chr"],"align":["left"]},{"label":["intensityLog2"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"WT","2":"WT_n3","3":"27.73900"},{"1":"WT","2":"WT_n3","3":"27.47128"},{"1":"WT","2":"WT_n3","3":"27.70466"},{"1":"WT","2":"WT_n4","3":"27.47251"},{"1":"WT","2":"WT_n4","3":"27.58132"},{"1":"WT","2":"WT_n4","3":"27.55821"},{"1":"WT","2":"WT_n5","3":"27.54348"},{"1":"WT","2":"WT_n5","3":"27.53997"},{"1":"WT","2":"WT_n5","3":"27.63349"},{"1":"D8","2":"D8_n3","3":"27.13884"},{"1":"D8","2":"D8_n3","3":"27.33571"},{"1":"D8","2":"D8_n3","3":"27.28402"},{"1":"D8","2":"D8_n4","3":"27.32043"},{"1":"D8","2":"D8_n4","3":"27.42848"},{"1":"D8","2":"D8_n4","3":"27.53619"},{"1":"D8","2":"D8_n5","3":"27.34253"},{"1":"D8","2":"D8_n5","3":"27.38901"},{"1":"D8","2":"D8_n5","3":"27.44917"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1"></a>franc <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb82-2"><a href="#cb82-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(biorep, intensityLog2, <span class="dt">color =</span> genotype)) <span class="op">+</span></span>
<span id="cb82-3"><a href="#cb82-3"></a><span class="st">  </span><span class="kw">geom_point</span>()</span></code></pre></div>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<ul>
<li>Response?</li>
<li>Experimental unit?</li>
<li>Observational unit?</li>
<li>Factors?</li>
</ul>
<p><span class="math inline">\(\rightarrow\)</span> Pseudo-replication, randomisation to bio-repeat and each bio-repeat measured in technical triplicate. <span class="math inline">\(\rightarrow\)</span> If we would analyse the data using a linear model based on each measured intensity, we would act as if we had sampled 18 bio-repeats. <span class="math inline">\(\rightarrow\)</span> Effect of interest has to be assessed between bio-repeats. So block analysis not possible!</p>
<p>If the same number of pseudo-replicates/technical replicates are available for each bio-repeat:</p>
<ul>
<li>average first over bio-repeats to obtain independent measurements.<br />
</li>
<li>averages will then have the same precision</li>
<li>assess effect of treatment using averages</li>
</ul>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1"></a>lmBiorep &lt;-<span class="st"> </span><span class="kw">lm</span>(intensityLog2 <span class="op">~</span><span class="st"> </span><span class="dv">-1</span> <span class="op">+</span><span class="st"> </span>biorep, franc)</span>
<span id="cb83-2"><a href="#cb83-2"></a>lmBiorep</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = intensityLog2 ~ -1 + biorep, data = franc)
## 
## Coefficients:
## biorepD8_n3  biorepD8_n4  biorepD8_n5  biorepWT_n3  biorepWT_n4  biorepWT_n5  
##       27.25        27.43        27.39        27.64        27.54        27.57</code></pre>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1"></a>francSum &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">genotype =</span> <span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;D8&quot;</span>,<span class="st">&quot;WT&quot;</span>),<span class="dt">each=</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.factor <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">relevel</span>(<span class="st">&quot;WT&quot;</span>), <span class="dt">intensityLog2 =</span> lmBiorep<span class="op">$</span>coef)</span>
<span id="cb85-2"><a href="#cb85-2"></a>francSum</span></code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["genotype"],"name":[1],"type":["fct"],"align":["left"]},{"label":["intensityLog2"],"name":[2],"type":["dbl"],"align":["right"]}],"data":[{"1":"D8","2":"27.25286","_rn_":"biorepD8_n3"},{"1":"D8","2":"27.42836","_rn_":"biorepD8_n4"},{"1":"D8","2":"27.39357","_rn_":"biorepD8_n5"},{"1":"WT","2":"27.63831","_rn_":"biorepWT_n3"},{"1":"WT","2":"27.53734","_rn_":"biorepWT_n4"},{"1":"WT","2":"27.57232","_rn_":"biorepWT_n5"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1"></a>lmSum &lt;-<span class="st"> </span><span class="kw">lm</span>(intensityLog2 <span class="op">~</span><span class="st"> </span>genotype, francSum)</span>
<span id="cb86-2"><a href="#cb86-2"></a><span class="kw">summary</span>(lmSum)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = intensityLog2 ~ genotype, data = francSum)
## 
## Residuals:
## biorepD8_n3 biorepD8_n4 biorepD8_n5 biorepWT_n3 biorepWT_n4 biorepWT_n5 
##    -0.10541     0.07010     0.03531     0.05566    -0.04531    -0.01034 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 27.58266    0.04333 636.581 3.65e-11 ***
## genotypeD8  -0.22439    0.06128  -3.662   0.0215 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.07505 on 4 degrees of freedom
## Multiple R-squared:  0.7702, Adjusted R-squared:  0.7128 
## F-statistic: 13.41 on 1 and 4 DF,  p-value: 0.02154</code></pre>
</div>
<div id="wrong-analysis" class="section level2">
<h2><span class="header-section-number">6.3</span> Wrong analysis</h2>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1"></a>lmWrong &lt;-<span class="st"> </span><span class="kw">lm</span>(intensityLog2 <span class="op">~</span><span class="st"> </span>genotype, franc)</span>
<span id="cb88-2"><a href="#cb88-2"></a><span class="kw">summary</span>(lmWrong)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = intensityLog2 ~ genotype, data = franc)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.21943 -0.04181 -0.01914  0.06537  0.17792 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) 27.35826    0.03457  791.48  &lt; 2e-16 ***
## genotypeWT   0.22439    0.04888    4.59 0.000302 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.1037 on 16 degrees of freedom
## Multiple R-squared:  0.5684, Adjusted R-squared:  0.5414 
## F-statistic: 21.07 on 1 and 16 DF,  p-value: 0.0003017</code></pre>
<p>Note, that the analysis where we ignore the fact that we have multiple technical repeats for each bio-repeat returns results that are way too liberal.</p>
<div id="no-type-i-error-control" class="section level3">
<h3><span class="header-section-number">6.3.1</span> No Type I error control!</h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1"></a>sigmaWithin &lt;-<span class="st"> </span><span class="kw">sigma</span>(lmBiorep)</span>
<span id="cb90-2"><a href="#cb90-2"></a>sigmaBetween &lt;-<span class="st"> </span><span class="kw">sigma</span>(lmSum)</span>
<span id="cb90-3"><a href="#cb90-3"></a>xBiorep &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~-</span><span class="dv">1</span><span class="op">+</span>biorep,franc)</span>
<span id="cb90-4"><a href="#cb90-4"></a>xWrong &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>genotype,franc)</span>
<span id="cb90-5"><a href="#cb90-5"></a></span>
<span id="cb90-6"><a href="#cb90-6"></a></span>
<span id="cb90-7"><a href="#cb90-7"></a><span class="kw">set.seed</span>(<span class="dv">2523</span>)</span>
<span id="cb90-8"><a href="#cb90-8"></a>nSim &lt;-<span class="st"> </span><span class="dv">1000</span></span>
<span id="cb90-9"><a href="#cb90-9"></a>resWrong &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>,nSim,<span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.data.frame</span>
<span id="cb90-10"><a href="#cb90-10"></a><span class="kw">names</span>(resWrong) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Estimate&quot;</span>,<span class="st">&quot;Std. Error&quot;</span>,<span class="st">&quot;t value&quot;</span>,<span class="st">&quot;pvalue&quot;</span>)</span>
<span id="cb90-11"><a href="#cb90-11"></a>resCorrect &lt;-<span class="st"> </span>resWrong</span>
<span id="cb90-12"><a href="#cb90-12"></a>genotype &lt;-<span class="st"> </span>franc<span class="op">$</span>genotype</span>
<span id="cb90-13"><a href="#cb90-13"></a>genotypeSum &lt;-<span class="st"> </span>francSum<span class="op">$</span>genotype</span>
<span id="cb90-14"><a href="#cb90-14"></a>biorep &lt;-<span class="st"> </span>franc<span class="op">$</span>biorep</span>
<span id="cb90-15"><a href="#cb90-15"></a></span>
<span id="cb90-16"><a href="#cb90-16"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nSim)</span>
<span id="cb90-17"><a href="#cb90-17"></a>{</span>
<span id="cb90-18"><a href="#cb90-18"></a>biorepSim &lt;-<span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">ncol</span>(xBiorep),<span class="dt">sd=</span>sigmaBetween)</span>
<span id="cb90-19"><a href="#cb90-19"></a>ySim &lt;-<span class="st"> </span>xBiorep<span class="op">%*%</span>biorepSim <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="kw">nrow</span>(xBiorep),<span class="dt">sd=</span>sigmaWithin)</span>
<span id="cb90-20"><a href="#cb90-20"></a>ySum &lt;-<span class="st"> </span><span class="kw">lm</span>(ySim<span class="op">~</span>biorep)<span class="op">$</span>coefficient</span>
<span id="cb90-21"><a href="#cb90-21"></a>resWrong[i,] &lt;-<span class="st"> </span><span class="kw">summary</span>(<span class="kw">lm</span>(ySim<span class="op">~</span>genotype))<span class="op">$</span>coefficient[<span class="dv">2</span>,]</span>
<span id="cb90-22"><a href="#cb90-22"></a>resCorrect[i,]&lt;-<span class="kw">summary</span>(<span class="kw">lm</span>(ySum<span class="op">~</span>genotypeSum))<span class="op">$</span>coefficient[<span class="dv">2</span>,]</span>
<span id="cb90-23"><a href="#cb90-23"></a>}</span>
<span id="cb90-24"><a href="#cb90-24"></a><span class="kw">mean</span>(resCorrect<span class="op">$</span>pvalue <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</span></code></pre></div>
<pre><code>## [1] 0.042</code></pre>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1"></a><span class="kw">mean</span>(resWrong<span class="op">$</span>pvalue <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</span></code></pre></div>
<pre><code>## [1] 0.143</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1"></a><span class="kw">qplot</span>(resCorrect<span class="op">$</span>pvalue,<span class="dt">geom =</span> <span class="st">&quot;histogram&quot;</span>,<span class="dt">boundary=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb94-2"><a href="#cb94-2"></a><span class="st">  </span><span class="kw">stat_bin</span>(<span class="dt">breaks=</span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb94-3"><a href="#cb94-3"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;pvalue&quot;</span>) <span class="op">+</span></span>
<span id="cb94-4"><a href="#cb94-4"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Correct analysis&quot;</span>)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Computation failed in `stat_bin()`:
## &#39;from&#39; must be of length 1</code></pre>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1"></a><span class="kw">qplot</span>(resWrong<span class="op">$</span>pvalue,<span class="dt">geom =</span> <span class="st">&quot;histogram&quot;</span>,<span class="dt">boundary=</span><span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb97-2"><a href="#cb97-2"></a><span class="st">  </span><span class="kw">stat_bin</span>(<span class="dt">breaks=</span><span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,.<span class="dv">1</span>)) <span class="op">+</span></span>
<span id="cb97-3"><a href="#cb97-3"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">&quot;pvalue&quot;</span>) <span class="op">+</span></span>
<span id="cb97-4"><a href="#cb97-4"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">&quot;Wrong analysis&quot;</span>)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Computation failed in `stat_bin()`:
## &#39;from&#39; must be of length 1</code></pre>
<p><img src="03-experimentalDesignIII_files/figure-html/unnamed-chunk-38-2.png" width="672" /></p>
<ul>
<li><p>So we observe that the analysis that does not account for pseudo-replication is too liberal!</p></li>
<li><p>The analysis that first summarizes over the technical repeats leads to correct p-values and correct type I error control!</p></li>
<li><p>Caution: NEVER SUMMARIZE OVER THE BIOREPEATS!</p></li>
<li><p>What to do when you have an unequal number of technical repeats: more advanced methods are required</p>
<ul>
<li>e.g. mixed models</li>
<li>The mixed model framework can model the correlation structure in the data</li>
<li>Mixed models can also be used when inference between and within blocks is needed, e.g. split-plot designs.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="nature-methods-split-plot-designs" class="section level1">
<h1><span class="header-section-number">7</span> Nature methods: Split-plot designs</h1>
<p><a href="https://www.nature.com/articles/nmeth.3293.pdf"></a></p>
</div>

<div id="rmd-source-code">LS0tCnRpdGxlOiAiMy4zIEV4cGVyaW1lbnRhbCBEZXNpZ24gSUlJOiBSYW5kb21pemVkIENvbXBsZXRlIEJsb2NrIERlc2lnbnMgYW5kIFBzZXVkby1yZXBsaWNhdGlvbiIKYXV0aG9yOiAiTGlldmVuIENsZW1lbnQiCmRhdGU6ICJzdGF0T21pY3MsIEdoZW50IFVuaXZlcnNpdHkgKGh0dHBzOi8vc3RhdG9taWNzLmdpdGh1Yi5pbykiCm91dHB1dDoKICBodG1sX2RvY3VtZW50OgogICAgY29kZV9kb3dubG9hZDogeWVzCiAgICB0aGVtZTogY29zbW8KICAgIHRvYzogeWVzCiAgICB0b2NfZmxvYXQ6IHllcwogICAgaGlnaGxpZ2h0OiB0YW5nbwogICAgbnVtYmVyX3NlY3Rpb25zOiB5ZXMKLS0tCgoKPGEgcmVsPSJsaWNlbnNlIiBocmVmPSJodHRwczovL2NyZWF0aXZlY29tbW9ucy5vcmcvbGljZW5zZXMvYnktbmMtc2EvNC4wIj48aW1nIGFsdD0iQ3JlYXRpdmUgQ29tbW9ucyBMaWNlbnNlIiBzdHlsZT0iYm9yZGVyLXdpZHRoOjAiIHNyYz0iaHR0cHM6Ly9pLmNyZWF0aXZlY29tbW9ucy5vcmcvbC9ieS1uYy1zYS80LjAvODh4MzEucG5nIiAvPjwvYT4KCmBgYHtyfQpsaWJyYXJ5KHRpZHl2ZXJzZSkKYGBgCgojIFJhbmRvbWl6ZWQgY29tcGxldGUgYmxvY2sgZGVzaWducwoKXFtcc2lnbWFeMj0gXHNpZ21hXjJfe2Jpb30rXHNpZ21hXjJfXHRleHR7bGFifSArXHNpZ21hXjJfXHRleHR7ZXh0cmFjdGlvbn0gKyBcc2lnbWFeMl9cdGV4dHtydW59ICsgXGxkb3RzXF0KCi0gQmlvbG9naWNhbDogZmx1Y3R1YXRpb25zIGluIHByb3RlaW4gbGV2ZWwgYmV0d2VlbiBtaWNlLCBmbHVjdGF0aW9ucyBpbiBwcm90ZWluIGxldmVsIGJldHdlZW4gY2VsbHMsIC4uLgotIFRlY2huaWNhbDogY2FnZSBlZmZlY3QsIGxhYiBlZmZlY3QsIHdlZWsgZWZmZWN0LCBwbGFzbWEgZXh0cmFjdGlvbiwgTVMtcnVuLCAuLi4KCiMgTmF0dXJlIG1ldGhvZHM6IFBvaW50cyBvZiBzaWduaWZpY2FuY2UgLSBCbG9ja2luZyAKW2h0dHBzOi8vd3d3Lm5hdHVyZS5jb20vYXJ0aWNsZXMvbm1ldGguMzAwNS5wZGZdKGh0dHBzOi8vd3d3Lm5hdHVyZS5jb20vYXJ0aWNsZXMvbm1ldGguMzAwNS5wZGYpCgotIE9uZXdheSBhbm92YSBpcyBhIHNwZWNpYWwgY2FzZSBvZiBhIGNvbXBsZXRlbHkgcmFuZG9taXplZCBkZXNpZ246CgogICAgLSB0aGUgZXhwZXJpbWVudGFsIHVuaXRzIGFyZSBzYW1wbGVkIGF0IHJhbmRvbSBmcm9tIHRoZSBwb3B1bGF0aW9uIAogICAgLSB0aGUgdHJlYXRtZW50cyBhcmUgcmFuZG9taXplZCB0byB0aGUgZXhwZXJpbWVudGFsIHVuaXRzIAogICAgLSBFdmVyeSBleHBlcmltZW50YWwgdW5pdCByZWNlaXZlcyBvbmUgdHJlYXRtZW50IGFuZCBpdHMgcmVzcG9uc2UgdmFyaWFibGUgaXMgbWVhc3VyZWQgb25jZS4gCgotIEluIGEgYmxvY2sgZGVzaWduIHRoZSBleHBlcmltZW50YWwgdW5pdHMgYXJlIGJsb2NrcyB3aGljaCBhcmUgc2FtcGxlZCBhdCByYW5kb20gb2YgdGhlIHBvcHVsYXRpb24gb2YgYWxsIHBvc3NpYmxlIGJsb2Nrcy4gCiAgICAKICAgIC0gVGhlIFJDQiByZXN0cmljdHMgcmFuZG9taXphdGlvbjogdGhlIHRyZWF0bWVudHMgYXJlIHJhbmRvbWl6ZWQgd2l0aGluIHRoZSBibG9ja3MuIAogICAgLSBpdCBjYW5ub3QgYmUgYW5hbHlzZWQgdXNpbmcgb25ld2F5IGFub3ZhLgogICAgLSBUaGUgcGFpcmVkIGRlc2lnbiBpcyBhIHNwZWNpYWwgY2FzZSBvZiBhbiBSQ0I6IGJsb2NrIHNpemUgZXF1YWxzIDIuCiAgICAtIFdpdGhpbiBibG9jayBlZmZlY3RzIGNhbiBiZSBhc3Nlc3NlZCB1c2luZyB0aGUgbG0gZnVuY3Rpb24gaW4gUi4KCiMgTW91c2UgZXhhbXBsZSAKCiMjIEJhY2tncm91bmQKCmBgYHtyIGVjaG89RkFMU0UsIG91dC53aWR0aD0iNTAlIn0Ka25pdHI6OmluY2x1ZGVfZ3JhcGhpY3MoImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9zdGF0T21pY3MvUFNMUzIxL21hc3Rlci9maWd1cmVzL21vdXNlVGNlbGxfUkNCX2Rlc2lnbi5wbmciKQpgYGAKCkR1Z3VldCBldCBhbC4gKDIwMTcpIE1DUCAxNig4KToxNDE2LTE0MzIuIGRvaTogMTAuMTA3NC9tY3AubTExNi4wNjI3NDUKCi0gQWxsIHRyZWF0bWVudHMgb2YgaW50ZXJlc3QgYXJlIHByZXNlbnQgd2l0aGluIGJsb2NrIQotIFdlIGNhbiBlc3RpbWF0ZSB0aGUgZWZmZWN0IG9mIHRoZSB0cmVhdG1lbnQgd2l0aGluIGJsb2NrIQoKV2UgZm9jdXMgb24gb25lIHByb3RlaW4KCiAgLSBUaGUgbWVhc3VyZWQgaW50ZW5zaXRpZXMgYXJlIGFscmVhZHkgb24gdGhlIGxvZzItc2NhbGUuIERpZmZlcmVuY2VzIGJldHdlZW4gdGhlIGludGVuc2l0aWVzIGNhbiB0aHVzIGJlIGludGVycHJldGVkIGFzIGxvZzIgRkMuIAogIC0gUDE2MDQ1IG9yIEdhbGVjdGluLTEuIAogIC0gRnVuY3Rpb246ICJMZWN0aW4gdGhhdCBiaW5kcyBiZXRhLWdhbGFjdG9zaWRlIGFuZCBhIHdpZGUgYXJyYXkgb2YgY29tcGxleCBjYXJib2h5ZHJhdGVzLiBQbGF5cyBhIHJvbGUgaW4gcmVndWxhdGluZyBhcG9wdG9zaXMsIGNlbGwgcHJvbGlmZXJhdGlvbiBhbmQgY2VsbCBkaWZmZXJlbnRpYXRpb24uIEluaGliaXRzIENENDUgcHJvdGVpbiBwaG9zcGhhdGFzZSBhY3Rpdml0eSBhbmQgdGhlcmVmb3JlIHRoZSBkZXBob3NwaG9yeWxhdGlvbiBvZiBMeW4ga2luYXNlLiBTdHJvbmcgaW5kdWNlciBvZiBULWNlbGwgYXBvcHRvc2lzLiIgKHNvdXJjZTogW3VuaXByb3RdKGh0dHBzOi8vd3d3LnVuaXByb3Qub3JnL3VuaXByb3QvUDE2MDQ1KSkKCiMjIERhdGEgRXhwbG9yYXRpb24gCgpgYGB7cn0KbW91c2UgPC0gcmVhZF90c3YoImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9zdGF0T21pY3MvUFNMUzIxL2RhdGEvbW91c2VQMTYwNDUudHh0IikKbW91c2UKYGBgCgoKYGBge3J9Cm1vdXNlICU+JSAKICBnZ3Bsb3QoYWVzKHggPSBtb3VzZSwgeT0gaW50ZW5zaXR5LCBjb2w9Y2VsbHR5cGUpKSArCiAgZ2VvbV9wb2ludCgpCmBgYAoKYGBge3J9Cm1vdXNlICU+JSAgCiAgICBnZ3Bsb3QoYWVzKHggPSBjZWxsdHlwZSwgeT0gaW50ZW5zaXR5KSkgKwogICAgZ2VvbV9ib3hwbG90KGFlcyhjb2w9Y2VsbHR5cGUpLG91dGxpZXIuc2hhcGUgPSBOQSkgKwogICAgZ2VvbV9saW5lKGFlcyhncm91cCA9IG1vdXNlKSkgKwogICAgZ2VvbV9wb2ludChhZXMoY29sPWNlbGx0eXBlKSkKYGBgCgoKIyMgUGFpcmVkIEFuYWx5c2lzCgpUaGlzIGlzIGEgcGFpcmVkIGRlc2lnbiwgd2hpY2ggaXMgdGhlIG1vc3Qgc2ltcGxlIGZvcm0gb2YgcmFuZG9taXplZCBjb21wbGV0ZSBibG9jayBkZXNpZ24uIAoKSW4gdGhlIHByZXZpb3VzIGxlY3R1cmUgd2Ugd291bGQgaGF2ZSBhbmFseXplZCB0aGUgZGF0YSBieSBkaWZmZXJlbmNpbmcuIAoKYGBge3J9Cm1vdXNlV2lkZSA8LSBtb3VzZSAlPiUgCiAgc3ByZWFkKGNlbGx0eXBlLGludGVuc2l0eSkgJT4lCiAgbXV0YXRlKGRlbHRhID0gVHJlZyAtIFRjb24pCm1vdXNlV2lkZQpgYGAKCiMjIyBEYXRhIGV4cGxvcmF0aW9uCgotIEJveHBsb3Qgb2YgZGlmZmVyZW5jZQoKYGBge3J9Cm1vdXNlV2lkZSAlPiUgCiAgZ2dwbG90KGFlcyh4PSIiLHk9ZGVsdGEpKSArCiAgZ2VvbV9ib3hwbG90KG91dGxpZXIuc2hhcGUgPSBOQSkgKyAKICBnZW9tX2ppdHRlcigpCmBgYAoKLSBTdW1tYXJ5IHN0YXRpc3RpY3MKYGBge3J9CmRlbHRhU3VtIDwtIG1vdXNlV2lkZSAlPiUgCiAgc3VtbWFyaXplX2F0KCJkZWx0YSIsIAogICAgICAgICAgICAgICBsaXN0KAogICAgICAgICAgICAgICAgICAgIG1lYW4gPSB+IG1lYW4oLixuYS5ybSA9IFRSVUUpLAogICAgICAgICAgICAgICAgICAgIHNkID0gfiBzZCguLG5hLnJtID0gVFJVRSksCiAgICAgICAgICAgICAgICAgICAgbiA9IH4gaXMubmEoLikgJT4lIGAhYCAlPiUgc3VtCiAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICkgJT4lIAogIG11dGF0ZShzZSA9IHNkL3NxcnQobikpCmRlbHRhU3VtCmBgYCAgCgoKLSBDb3ZhcmlhbmNlIGFuZCBjb3JyZWxhdGlvbiBiZXR3ZWVuIGV4cHJlc3Npb24gaW4gYm90aCBjZWxsdHlwZXMgCgpgYGB7cn0KY29yKG1vdXNlV2lkZVssYygiVGNvbiIsIlRyZWciKV0pCnZhcihtb3VzZVdpZGVbLGMoIlRjb24iLCJUcmVnIildKQp2YXIobW91c2VXaWRlWyxjKCJUY29uIiwiVHJlZyIpXSkgJT4lIAogIGRpYWcgJT4lIAogIHNxcnQKYGBgCgpOb3RpY2UgdGhhdCB0aGVyZSBpcyBhIGxhcmdlIGNvcnJlbGF0aW9uIGJldHdlZW4gdGhlIGV4cHJlc3Npb24gb2YgdGhlIHByb3RlaW4gaW4gY29udmVudGlvbmFsIGFuZCByZWd1bGF0b3J5IFQtY2VsbHMuIAoKLSBTdGFuZGFyZCBkZXZpYXRpb24gb2YgZGlmZmVyZW5jZT8gCgokJApcYmVnaW57YXJyYXl9e2xjbH0KXHRleHR7c2R9X3t4X3IgLSB4X2N9ICY9JiBcc3FydHsxXjJcaGF0IFxzaWdtYV9yXjIgKyAoLTEpXjIgXGhhdCBcc2lnbWFfY14yICsgMiBcdGltZXMgMSAKXHRpbWVzIC0xIApcdGltZXMgXGhhdFxzaWdtYV97cixjfX1cXAomPSZcc3FydHtcaGF0IFxzaWdtYV9yXjIgKyBcaGF0IFxzaWdtYV9jXjIgLSAyIFx0aW1lcyBcaGF0XHNpZ21hX3tyLGN9fQpcZW5ke2FycmF5fQokJAoKYGBge3J9CnNkRGVsdGEyIDwtIChjKC0xLDEpICUqJSB2YXIobW91c2VXaWRlWyxjKCJUY29uIiwiVHJlZyIpXSkgJSolIGMoLTEsMSkpICU+JQogIHNxcnQKc2REZWx0YTIKCnNlRGVsdGFCYXIgPC0gc2REZWx0YTIgLyBzcXJ0KGRlbHRhU3VtJG4pCnNlRGVsdGFCYXIKCmRlbHRhU3VtCmBgYAoKLSBUaGUgc3RhbmRhcmQgZGV2aWF0aW9uIG9uIHRoZSBkaWZmZXJlbmNlIGlzIG11Y2ggbG93ZXIgYmVjYXVzZSBvZiB0aGUgc3Ryb25nIGNvcnJlbGF0aW9uIQotIE5vdGUsIHRoYXQgdGhlIHBhaXJlZCBkZXNpZ24gZW5hYmxlZCB1cyB0byBlc3RpbWF0ZSB0aGUgZGlmZmVyZW5jZSBpbiBsb2cyLWV4cHJlc3Npb24gYmV0d2VlbiB0aGUgdHdvIGNlbGwgdHlwZXMgaW4gZXZlcnkgYW5pbWFsIChsb2cyIEZDKS4gCgojIyBSYW5kb21pemVkIGNvbXBsZXRlIGJsb2NrIGFuYWx5c2lzCgpXZSBjYW4gYWxzbyBhbmFseXNlIHRoZSBkZXNpZ24gdXNpbmcgYSBsaW5lYXIgbW9kZWwgd2l0aCBhIG1haW4gZWZmZWN0IGZvciBjZWxsIHR5cGUgYW5kIGEgbWFpbiBlZmZlY3QgZm9yIHRoZSBibG9jayBmYWN0b3IgbW91c2UuIApCZWNhdXNlIHdlIGhhdmUgbWVhc3VyZWQgdGhlIHR3byBjZWxsIHR5cGVzIGluIGV2ZXJ5IG1vdXNlLCB3ZSBjYW4gZXN0aW1hdGUgdGhlIGF2ZXJhZ2UgbG9nMi1pbnRlbnNpdHkgb2YgdGhlIHByb3RlaW4gaW4gdGhlIFQtY2VsbHMgZm9yIGVhY2ggbW91c2UuIAoKYGBge3J9CmxtUkNCIDwtIGxtKGludGVuc2l0eSB+IGNlbGx0eXBlICsgbW91c2UsIG1vdXNlKQpwbG90KGxtUkNCLCB3aGljaCA9IGMoMSwyLDMpKQpgYGAKCklmIHlvdSBoYXZlIGRvdWJ0cyBvbiB0aGUgYXNzdW1wdGlvbnMgeW91IGNhbiBhbHdheXMgc2ltdWxhdGUgZGF0YSBmcm9tIGEgbW9kZWwgd2l0aCBzaW1pbGFyIGVmZmVjdHMgYXMgb3VycyBidXQgd2hlcmUgYXJlIGRpc3RyaWJ1dGlvbmFsIGFzc3VtcHRpb25zIGhvbGQgYW5kIGNvbXBhcmUgdGhlIHJlc2lkdWFsIHBsb3RzLiAKCmBgYHtyfQpkZXNpZ24gPC0gIG1vZGVsLm1hdHJpeChpbnRlbnNpdHkgfiBjZWxsdHlwZSArIG1vdXNlLCBtb3VzZSkgCnNpZ21hTW91c2UgPC0gc3FydChjYXI6OkFub3ZhKGxtUkNCLCB0eXBlID0gIklJSSIpWyJtb3VzZSIsIlN1bSBTcSJdL2Nhcjo6QW5vdmEobG1SQ0IsIHR5cGUgPSAiSUlJIilbIm1vdXNlIiwiRGYiXSkgCmJldGFzIDwtIGxtUkNCJGNvZWZmaWNpZW50cwpuTW91c2UgPC0gbW91c2UkbW91c2UgJT4lIHVuaXF1ZSAlPiUgbGVuZ3RoCgpwYXIobWZyb3c9YygzLDMpKQpmb3IgKGkgaW4gMTo5KQp7CiAgICBtb3VzZUVmZmVjdCA8LSBybm9ybShuTW91c2UsIHNkID0gc2lnbWFNb3VzZSkKICAgIGJldGFzTW91c2UgPC0gbW91c2VFZmZlY3RbLTFdLW1vdXNlRWZmZWN0WzFdCiAgICBiZXRhc1stYygxOjIpXSA8LSBiZXRhc01vdXNlIAogICAgeXNpbSA8LSBkZXNpZ24gJSolIGJldGFzICArIHJub3JtKG5yb3coZGVzaWduKSxzZD1zaWdtYShsbVJDQikpCiAgICBwbG90KGxtKHlzaW0gfiAtMSArIGRlc2lnbiksIHdoaWNoID0gMSkgCn0KYGBgCgpgYGB7cn0KYW5vdmFSQ0IgPC0gY2FyOjpBbm92YShsbVJDQiwgdHlwZSA9ICJJSUkiKQpzdW1tYXJ5KGxtUkNCKQp0LnRlc3QobW91c2VXaWRlJGRlbHRhKQphbm92YVJDQgpgYGAKCk5vdGljZSB0aGF0CgoxLiB0aGUgZXN0aW1hdGUsIHNlLCB0LXRlc3Qgc3RhdGlzdGljIGFuZCBwLXZhbHVlIGZvciB0aGUgY2VsbHR5cGUgZWZmZWN0IG9mIGludGVyZXN0IGlzIHRoZSBzYW1lIGFzIGluIHRoZSBwYWlyZWQgdC10ZXN0IQoKMi4gdGhlIGFub3ZhIGFuYWx5c2lzIHNob3dzIHRoYXQgd2Ugd2lsbCBtb2RlbCB0aGUgdG90YWwgdmFyaWFiaWxpdHkgaW4gdGhlIHByb3RlaW4gZXhwcmVzc2lvbiBpbiBULWNlbGxzIHVzaW5nICB2YXJpYWJpbGl0eSBkdWUgdG8gdGhlIGNlbGwgdHlwZSAoQ1QpLCB0aGUgdmFyaWFiaWxpdHkgZnJvbSBtb3VzZSB0byBtb3VzZSAoTSkgYW5kIHJlc2lkdWFsIHZhcmlhYmlsaXR5IChSKSB3aXRoaW4gbW91c2UgdGhhdCB3ZSBjYW5ub3QgZXhwbGFpbi4gSW5kZWVkLCAKCiQkClxiZWdpbnthcnJheX17bGNsfQpcdGV4dHtTU1RvdH0gJj0mIFx0ZXh0e1NTQ1R9ICsgXHRleHR7U1NNfSArIFx0ZXh0e1NTUn1cXApgciByb3VuZChhbm92YVJDQlstMSwiU3VtIFNxIl0gJT4lIHN1bSgpLDEpYCAmPSYgYHIgcm91bmQoYW5vdmFSQ0JbImNlbGx0eXBlIiwiU3VtIFNxIl0sMSlgICsgYHIgcm91bmQoYW5vdmFSQ0JbIm1vdXNlIiwiU3VtIFNxIl0sMSlgICsgYHIgcm91bmQoYW5vdmFSQ0JbIlJlc2lkdWFscyIsIlN1bSBTcSJdLDEpYApcZW5ke2FycmF5fQokJAoKU28gdGhlIGNlbGx0eXBlIGFuZCB0aGUgbW91c2UgZWZmZWN0IGV4cGxhaW4gcmVzcGVjdGl2ZWx5IAokJApcYmVnaW57YXJyYXl9e2xsfQpcZnJhY3tcdGV4dHtTU0NUfX17XHRleHR7U1NUb3R9fVx0aW1lcyAxMDAmXGZyYWN7XHRleHR7U1NNfX17XHRleHR7U1NUb3R9fVx0aW1lcyAxMDBcXFxcCmByIHJvdW5kKGFub3ZhUkNCWyJjZWxsdHlwZSIsIlN1bSBTcSJdL3N1bShhbm92YVJDQlstMSwiU3VtIFNxIl0pKjEwMCwxKWAmCmByIHJvdW5kKGFub3ZhUkNCWyJtb3VzZSIsIlN1bSBTcSJdL3N1bShhbm92YVJDQlstMSwiU3VtIFNxIl0pKjEwMCwxKWBcXApcZW5ke2FycmF5fQokJAoKcGVyY2VudCBvZiB0aGUgdmFyaWFiaWxpdHkgaW4gdGhlIHByb3RlaW4gZXhwcmVzc2lvbiB2YWx1ZXMgYW5kIAokJCAKXGZyYWN7XHRleHR7UlNTfX17XHRleHR7U1NUb3R9fSBcdGltZXMgMTAwID0gYHIgcm91bmQoYW5vdmFSQ0JbIlJlc2lkdWFscyIsIlN1bSBTcSJdL3N1bShhbm92YVJDQlstMSwiU3VtIFNxIl0pKjEwMCwxKWAKJCQKcGVyY2VudCBjYW5ub3QgYmUgZXhwbGFpbmVkLiAKCk5vdGUsIHRoYXQgCgotIHRoZSB2YXJpYWJpbGl0eSBmcm9tIG1vdXNlIHRvIG1vdXNlIGlzIHRoZSBsYXJnZXN0IHNvdXJjZSBvZiB2YXJpYWJpbGl0eSBpbiB0aGUgbW9kZWwsIAotIFRoaXMgdmFyaWFiaWxpdHkgY2FuIGJlIGVzdGltYXRlZCB3aXRoIHRoZSBSQ0IgZGVzaWduIGFuZAotIGNhbiB0aHVzIGJlIGlzb2xhdGVkIGZyb20gdGhlIHJlc2lkdWFsIHZhcmlhYmlsaXR5Ci0gbGVhZGluZyB0byBhIG11Y2ggaGlnaGVyIHByZWNpc2lvbiBvbiB0aGUgZXN0aW1hdGUgb2YgdGhlIGF2ZXJhZ2UgbG9nMiBGQyBiZXR3ZWVuIHJlZ3VsYXRvcnkgYW5kIGNvbnZlbnRpb25hbCBULWNlbGxzIHRoYXQgd2hhdCB3b3VsZCBiZSBvYnRhaW5lZCB3aXRoIGEgQ1JEIQoKTm90ZSwgdGhhdCB0aGUgUkNCIGFsc28gaGFzIHRvIHNhY3JpZmlzZSBhIG51bWJlciBvZiBkZWdyZWVzIG9mIGZyZWVkb20gdG8gZXN0aW1hdGUgdGhlIG1vdXNlIGVmZmVjdCwgaGVyZSA2IERGLgoKSGVuY2UsIHRoZSBwb3dlciBnYWluIG9mIHRoZSBSQ0IgaXMgYSB0cmFkZS1vZmYgYmV0d2VlbiB0aGUgdmFyaWFiaWxpdHkgdGhhdCBjYW4gYmUgZXhwbGFpbmVkIGJ5IHRoZSBibG9jayBlZmZlY3QgYW5kIHRoZSBsb3NzIGluIERGLgoKCklmIHlvdSByZW1lbWJlciB0aGUgZXF1YXRpb24gb2YgdmFyaWFuY2UgY292YXJpYW5jZSBtYXRyaXggb2YgdGhlIHBhcmFtZXRlciBlc3RpbWF0b3JzCiQkClxoYXR7XGJvbGRzeW1ib2x7XFNpZ21hfX1eMl97XGhhdHtcYm9sZHN5bWJvbHtcYmV0YX19fQo9XGxlZnQoXG1hdGhiZntYfV5UXG1hdGhiZntYfVxyaWdodCleey0xfVxoYXRcc2lnbWFeMgokJAoKeW91IGNhbiBzZWUgdGhhdCB0aGUgcmFuZG9taXplZCBjb21wbGV0ZSBibG9jayB3aWxsIGhhdmUgYW4gaW1wYWN0IG9uIAoKLSAkXGxlZnQoXG1hdGhiZntYfV5UXG1hdGhiZntYfVxyaWdodCleey0xfSQgYXMgd2VsbCBhcyAKLSBvbiAkXHNpZ21hXjIkIG9mIHRoZSByZXNpZHVhbHMhCgpXZSB3ZXJlIGFibGUgdG8gaXNvbGF0ZSB0aGUgdmFyaWFuY2UgaW4gZXhwcmVzc2lvbiBiZXR3ZWVuIGFuaW1hbHMvYmxvY2tzIGZyb20gb3VyIGFuYWx5c2lzISAkXHJpZ2h0YXJyb3ckIHRoaXMgd2lsbCByZWR1Y2UgdGhlIHZhcmlhbmNlIG9mIHRoZSByZXNpZHVhbHMgYW5kIHdpbGwgbGVhZCB0byBwb3dlciBnYWluIGlmIHRoZSB2YXJpYWJpbGl0eSBiZXR3ZWVuIG1pY2UvYmxvY2tzIGlzIGxhcmdlLgoKQWxzbyBub3RlIHRoYXQsIAoKJCQKXGhhdFxzaWdtYV4yID0gXGZyYWN7XHRleHR7U1NSfX17bi1wfSA9IFxmcmFje1NTVG90IC0gU1NNIC0gU1NDVH17bi1wfSAKJCQgCgotIEhlbmNlLCBibG9ja2luZyBpcyBiZW5lZmljaWFsIGlmIHRoZSByZWR1Y3Rpb24gaW4gc3VtIG9mIHNxdWFyZXMgb2YgdGhlIHJlc2lkdWFscyBpcyBsYXJnZSBjb21wYXJlZCB0byB0aGUgZGVncmVlcyBvZiBmcmVlZG9tIHRoYXQgYXJlIHNhY3JpZmlzZWQuIAotIFRodXMgaWYgU1NNIGNhbiBleHBsYWluIGEgbGFyZ2UgcGFydCBvZiB0aGUgdG90YWwgdmFyaWFiaWxpdHkuCgpGdXJ0aGVyLCB0aGUgZGVncmVlcyBvZiBmcmVlZG9tIGFmZmVjdCB0aGUgdC1kaXN0cmlidXRpb24gdGhhdCBpcyB1c2VkIGZvciBpbmZlcmVuY2UsIHdoaWNoIGhhcyBicm9hZGVyIHRhaWxzIGlmIHRoZSByZXNpZHVhbCBkZWdyZWVzIG9mIGZyZWVkb20gJG4tcCQgYXJlIGdldHRpbmcgc21hbGxlci4gCgojIFBvd2VyIGdhaW4gb2YgYW4gUkNCIHZzIENSRAoKSW4gdGhpcyBzZWN0aW9uIHdlIHdpbGwgc3Vic2V0IHRoZSBvcmlnaW5hbCBkYXRhIGluIHR3byBleHBlcmltZW50czoKCi0gQSByYW5kb21pemVkIGNvbXBsZXRlIGJsb2NrIGRlc2lnbiB3aXRoIHRocmVlIG1pY2UgCi0gQSBjb21wbGV0ZWx5IHJhbmRvbWl6ZWQgZGVzaWduIHdpdGggc2l4IG1pY2UgYnV0IHdoZXJlIHdlIG9ubHkgbWVhc3VyZSBvbmUgY2VsbCB0eXBlIGluIGVhY2ggbW91c2UuCgpgYGB7cn0Kc2V0LnNlZWQoODU5KQptUmNiIDwtIG1vdXNlICU+JSAKICBwdWxsKG1vdXNlKSAlPiUKICB1bmlxdWUgJT4lCiAgc2FtcGxlKHNpemU9MykKCnJjYlNtYWxsIDwtIG1vdXNlICU+JSBmaWx0ZXIobW91c2UlaW4lbVJjYikKcmNiU21hbGwKYGBgCgpgYGB7cn0KbUNyZCA8LSBtb3VzZSAlPiUgCiAgcHVsbChtb3VzZSkgJT4lCiAgdW5pcXVlICU+JQogIHNhbXBsZShzaXplPTYpCgoKY3JkU21hbGwgPC0gCiAgYmluZF9yb3dzKAogICAgbW91c2UgJT4lIAogICAgICBmaWx0ZXIobW91c2UlaW4lbUNyZFsxOjNdKSAlPiUgCiAgICAgIGZpbHRlcihjZWxsdHlwZT09IlRjb24iKSwKICAgIG1vdXNlICU+JSAKICAgICAgZmlsdGVyKG1vdXNlJWluJW1DcmRbLSgxOjMpXSkgJT4lIAogICAgICBmaWx0ZXIoY2VsbHR5cGU9PSJUcmVnIikpCmNyZFNtYWxsCmBgYAoKU28gaW4gYm90aCBleHBlcmltZW50cyB3ZSBuZWVkIHRvIGRvIHNpeCBtYXNzIHNwZWN0cm9tZXRyeSBydW5zLiAKCgpgYGB7cn0KbG1DUkRTbWFsbCA8LSBsbShpbnRlbnNpdHkgfiBjZWxsdHlwZSwgY3JkU21hbGwpCnN1bW1hcnkobG1DUkRTbWFsbCkKYW5vdmEobG1DUkRTbWFsbCkKYGBgCgpgYGB7cn0KbG1SQ0JTbWFsbCA8LSBsbShpbnRlbnNpdHkgfiBjZWxsdHlwZSArIG1vdXNlLCByY2JTbWFsbCkKYW5vdmEobG1SQ0JTbWFsbCkKc3VtbWFyeShsbVJDQlNtYWxsKQpgYGAKCgpOb3RlLCB0aGF0IAoKLSB3ZSBhcmUgYWJsZSB0byBwaWNrIHVwIHRoZSB1cHJlZ3VsYXRpb24gYmV0d2VlbiByZWd1bGF0b3J5IFQtY2VsbHMgYW5kIG9yZGluYXJ5IFQtY2VsbHMgd2l0aCB0aGUgUkNCIGJ1dCBub3Qgd2l0aCB0aGUgQ1JELiAKLSB0aGUgc3RhbmRhcmQgZXJyb3Igb2YgdGhlICRcbG9nXzJcdGV4dHtGQ31fXHRleHR7VHJlZy1UY29ufSQgZXN0aW1hdGUgaXMgYSBmYWN0b3IgYHIgcm91bmQoc3VtbWFyeShsbUNSRFNtYWxsKSRjb2VmWyJjZWxsdHlwZVRyZWciLCJTdGQuIEVycm9yIl0vc3VtbWFyeShsbVJDQlNtYWxsKSRjb2VmWyJjZWxsdHlwZVRyZWciLCJTdGQuIEVycm9yIl0sMSlgIHNtYWxsZXIgZm9yIHRoZSBSQ0IgZGVzaWduISAKCkEgZ29vZCBiaW9sb2dpc3RzIHdobyBrbm93cyBhYm91dCBibG9ja2luZyBidXQgd2hvIGlzIGEgcG9vciBkYXRhIGFuYWxpc3Qgd2hvIGZvcmdldHMgYWJvdXQgdGhlIGJsb2NraW5nIHdpbGwgYmUgYmFjayBhdCBzcXVhcmUgb25lOgoKYGBge3J9Cndyb25nUmJjIDwtIGxtKGludGVuc2l0eSB+IGNlbGx0eXBlLCByY2JTbWFsbCkKYW5vdmEod3JvbmdSYmMpCnN1bW1hcnkod3JvbmdSYmMpCmBgYAoKU28sIHdlIHNlZSB0aGF0IHRoZSBibG9jayB0byBibG9jayB2YXJpYWJpbGl0eSBpcyB0aGVuIGFic29yYmVkIGFnYWluIGluIHRoZSB2YXJpYW5jZSBlc3RpbWF0b3Igb2YgdGhlIHJlc2lkdWFsLgoKT2YgY291cnNlLCB3ZSBhcmUgbmV2ZXIgYWxsb3dlZCB0byBhbmFseXNlIGFuIFJDQiB3aXRoIGEgbW9kZWwgZm9yIGEgQ1JEICh3aXRob3V0IGJsb2NrIGZhY3RvcikgYmVjYXVzZSBibG9ja2luZyBpbXBvc2VzIGEgcmFuZG9taXNhdGlvbiByZXN0cmljdGlvbjogd2UgcmFuZG9taXplIHRoZSB0cmVhdG1lbnQgd2l0aGluIGJsb2NrLiAKCiMjIFBvd2VyZ2FpbiBvZiBibG9ja2luZz8gCgojIyMgUG93ZXIgZm9yIGNvbXBsZXRlbHkgcmFuZG9taXplZCBkZXNpZ24gCgpgYGB7cn0KdmFyQmV0d2VlblBsdXNXaXRoaW4gPC0gc3VtKGNhcjo6QW5vdmEobG1SQ0IsdHlwZT0iSUlJIilbYygibW91c2UiLCJSZXNpZHVhbHMiKSwiU3VtIFNxIl0pL3N1bShjYXI6OkFub3ZhKGxtUkNCLHR5cGU9IklJSSIpW2MoIm1vdXNlIiwiUmVzaWR1YWxzIiksIkRmIl0pCgphbHBoYSA8LSAwLjA1Cm5TaW0gPC0gMjAwMDAKYjAgPC0gMApzZCA8LSBzcXJ0KHZhckJldHdlZW5QbHVzV2l0aGluKQpucyA8LSAgYygzLDcpICAKZGVsdGFzIDwtIGxtUkNCJGNvZWZmaWNpZW50c1siY2VsbHR5cGVUcmVnIl0KCkwgPC0gbGltbWE6Om1ha2VDb250cmFzdHMoImNlbGx0eXBlVHJlZyIsbGV2ZWxzPWMoIihJbnRlcmNlcHQpIiwiY2VsbHR5cGVUcmVnIikpCgpwb3dlckZhc3QgPC0gbWF0cml4KE5BLG5yb3c9bGVuZ3RoKG5zKSpsZW5ndGgoZGVsdGFzKSxuY29sPTMpICU+JSBhcy5kYXRhLmZyYW1lCm5hbWVzKHBvd2VyRmFzdCkgPC0gYygiYjEiLCJuIiwicG93ZXIiKQoKaSA8LSAwCmZvciAobiBpbiBucykKewogIG4xIDwtIG4yIDwtICBuCiAgCiAgIyMjIFNpbXVsYXRpb24KICBwcmVkaWN0b3JEYXRhIDwtIGRhdGEuZnJhbWUoY2VsbHR5cGUgPSByZXAoYygiVGNvbiIsIlRyZWciKSxjKG4xLG4yKSkgJT4lIGFzLmZhY3RvcikKICBkZXNpZ24gPC0gbW9kZWwubWF0cml4KH5jZWxsdHlwZSxwcmVkaWN0b3JEYXRhKQogIAogIGZvciAoYjEgaW4gZGVsdGFzKQogIHsKICAgIHlTaW0gPC0gcm5vcm0obnJvdyhwcmVkaWN0b3JEYXRhKSpuU2ltLHNkPXNkKQogICAgZGltKHlTaW0pIDwtYyhucm93KHByZWRpY3RvckRhdGEpLG5TaW0pCiAgICB5U2ltIDwtIHlTaW0gKyBjKGRlc2lnbiAlKiVjKGIwLGIxKSkKICAgIHlTaW0gPC0gdCh5U2ltKQogIAogICAgIyMjIEZpdHRpbmcKICAgIGZpdEFsbCA8LSBsaW1tYTo6bG1GaXQoeVNpbSxkZXNpZ24pCiAgCiAgICAjIyMgSW5mZXJlbmNlCiAgICB2YXJVbnNjYWxlZCA8LSBjKHQoTCklKiVmaXRBbGwkY292LmNvZWZmaWNpZW50cyUqJUwpCiAgICBjb250cmFzdHMgPC0gZml0QWxsJGNvZWZmaWNpZW50cyAlKiVMCiAgICBzZUNvbnRyYXN0cyA8LSB2YXJVbnNjYWxlZF4uNSpmaXRBbGwkc2lnbWEKICAgIHRzdGF0cyA8LSBjb250cmFzdHMvc2VDb250cmFzdHMKICAgIHB2YWxzIDwtIHB0KGFicyh0c3RhdHMpLGZpdEFsbCRkZi5yZXNpZHVhbCxsb3dlci50YWlsID0gRkFMU0UpKjIKICAgIAogICAgaSA8LSBpKzEKICAgIHBvd2VyRmFzdFtpLF0gPC0gYyhiMSxuLG1lYW4ocHZhbHMgPCBhbHBoYSkpCiAgfQp9CnBvd2VyRmFzdApgYGAKCkJlY2F1c2Ugd2UgaGF2ZSBhIHNpbXBsZSAyIGdyb3VwIGNvbXBhcmlzb24gd2UgY2FuIGFsc28gY2FsY3VsYXRlIHRoZSBwb3dlciB1c2luZyB0aGUgIGBwb3dlci50LnRlc3RgIGZ1bmN0aW9uLgoKYGBge3J9CnBvd2VyLnQudGVzdChuID0gMyxkZWx0YSA9IGxtUkNCJGNvZWZmaWNpZW50c1siY2VsbHR5cGVUcmVnIl0sIHNkID0gc3FydCh2YXJCZXR3ZWVuUGx1c1dpdGhpbikpCnBvd2VyLnQudGVzdChuID0gNyxkZWx0YSA9IGxtUkNCJGNvZWZmaWNpZW50c1siY2VsbHR5cGVUcmVnIl0sIHNkID0gc3FydCh2YXJCZXR3ZWVuUGx1c1dpdGhpbikpCmBgYAoKIyMgUG93ZXIgZm9yIHJhbmRvbWl6ZWQgY29tcGxldGUgYmxvY2sgZGVzaWduIAoKCgoKYGBge3J9CmFscGhhIDwtIDAuMDUKblNpbSA8LSAyMDAwMApiMCA8LSAwCnNkIDwtIHNpZ21hKGxtUkNCKQpzZE1vdXNlPC0gc3FydChjYXI6OkFub3ZhKGxtUkNCKVsibW91c2UiLCJTdW0gU3EiXS9jYXI6OkFub3ZhKGxtUkNCKVsibW91c2UiLCJEZiJdKSAKbnMgPC0gIGMoMyw3KSAgCmRlbHRhcyA8LSBsbVJDQiRjb2VmZmljaWVudHNbImNlbGx0eXBlVHJlZyJdCgoKcG93ZXJGYXN0QmxvY2tpbmcgPC0gbWF0cml4KE5BLG5yb3c9bGVuZ3RoKG5zKSpsZW5ndGgoZGVsdGFzKSxuY29sPTMpICU+JSBhcy5kYXRhLmZyYW1lCm5hbWVzKHBvd2VyRmFzdEJsb2NraW5nKSA8LSBjKCJiMSIsIm4iLCJwb3dlciIpCgppIDwtIDAKZm9yIChuIGluIG5zKQp7CiAgCiAgIyMjIFNpbXVsYXRpb24KICBwcmVkaWN0b3JEYXRhIDwtIGRhdGEuZnJhbWUoY2VsbHR5cGUgPSByZXAoYygiVGNvbiIsIlRyZWciKSxlYWNoPW4pICU+JSBhcy5mYWN0b3IsIG1vdXNlID0gcGFzdGUwKCJtIixyZXAoMTpuLDIpKSkKICBkZXNpZ24gPC0gbW9kZWwubWF0cml4KH4gY2VsbHR5cGUgKyBtb3VzZSxwcmVkaWN0b3JEYXRhKQogIEwgPC0gbGltbWE6Om1ha2VDb250cmFzdHMoImNlbGx0eXBlVHJlZyIsbGV2ZWxzPWNvbG5hbWVzKGRlc2lnbikpCgogIGZvciAoYjEgaW4gZGVsdGFzKQogIHsKICAgIHlTaW0gPC0gcm5vcm0obnJvdyhwcmVkaWN0b3JEYXRhKSpuU2ltLHNkPXNkKQogICAgZGltKHlTaW0pIDwtYyhucm93KHByZWRpY3RvckRhdGEpLG5TaW0pCiAgICBtb3VzZUVmZmVjdCA8LSBybm9ybShuLCBzZCA9IHNkTW91c2UpCiAgICBiZXRhc01vdXNlIDwtIG1vdXNlRWZmZWN0Wy0xXS1tb3VzZUVmZmVjdFsxXQogICAgeVNpbSA8LSB5U2ltICsgYyhkZXNpZ24gJSolYyhiMCxiMSxiZXRhc01vdXNlKSkKICAgIHlTaW0gPC0gdCh5U2ltKQogIAogICAgIyMjIEZpdHRpbmcKICAgIGZpdEFsbCA8LSBsaW1tYTo6bG1GaXQoeVNpbSxkZXNpZ24pCiAgCiAgICAjIyMgSW5mZXJlbmNlCiAgICB2YXJVbnNjYWxlZCA8LSBjKHQoTCklKiVmaXRBbGwkY292LmNvZWZmaWNpZW50cyUqJUwpCiAgICBjb250cmFzdHMgPC0gZml0QWxsJGNvZWZmaWNpZW50cyAlKiVMCiAgICBzZUNvbnRyYXN0cyA8LSB2YXJVbnNjYWxlZF4uNSpmaXRBbGwkc2lnbWEKICAgIHRzdGF0cyA8LSBjb250cmFzdHMvc2VDb250cmFzdHMKICAgIHB2YWxzIDwtIHB0KGFicyh0c3RhdHMpLGZpdEFsbCRkZi5yZXNpZHVhbCxsb3dlci50YWlsID0gRkFMU0UpKjIKICAgIAogICAgaSA8LSBpKzEKICAgIHBvd2VyRmFzdEJsb2NraW5nW2ksXSA8LSBjKGIxLG4sbWVhbihwdmFscyA8IGFscGhhKSkKICB9Cn0KcG93ZXJGYXN0QmxvY2tpbmcKYGBgCgpCZWNhdXNlIHdlIGhhdmUgYW4gUkNCIHdpdGggYSBibG9jayBzaXplIG9mIDIgKHBhaXJlZCBkZXNpZ24pIHdlIGNhbiBhbHNvIGNhbGN1bGF0ZSB0aGUgcG93ZXIgdXNpbmcgdGhlIGBwb3dlci50LnRlc3QgZnVuY3Rpb25gIHdpdGggYHR5cGUgPSAib25lLnNhbXBsZSJgIGFuZCBgc2RgIGVxdWFsIHRvIHRoZSBzdGFuZGFyZCBkZXZpYXRpb24gb2YgdGhlIGRpZmZlcmVuY2UuCgpOb3RlLCB0aGF0IHRoZSBwb3dlciBpcyBpbmRlZWQgbXVjaCBsYXJnZXIgZm9yIHRoZSByYW5kb21pemVkIGNvbXBsZXRlIGJsb2NrIGRlc2lnbi4gCkJvdGggZm9yIHRoZSBkZXNpZ25zIHdpdGggNiBhbmQgMTQgbWFzcyBzcGVjdHJvbWV0ZXIgcnVucyBoYXZlIHRvIGJlIGRvbmUuIAoKYGBge3J9CnBvd2VyLnQudGVzdChuID0gMyxkZWx0YSA9IG1lYW4obW91c2VXaWRlJGRlbHRhKSwgc2QgPSBzZChtb3VzZVdpZGUkZGVsdGEpKQpwb3dlci50LnRlc3QobiA9IDcsZGVsdGEgPSBtZWFuKG1vdXNlV2lkZSRkZWx0YSksIHNkID0gc2QobW91c2VXaWRlJGRlbHRhKSkKYGBgCgpOb3RlLCB0aGF0IHRoZSBwb3dlciBpcyBzbGlnaHRseSBkaWZmZXJlbnQgYmVjYXVzZSBmb3IgdGhlIHBvd2VyLnQudGVzdCBmdW5jdGlvbiB3ZSBjb25kaXRpb25lZCBvbiB0aGUgbWljZSBmcm9tIG91ciBzdHVkeS4gCgpJbiB0aGUgc2ltdWxhdGlvbiBzdHVkeSB3ZSBnZW5lcmF0ZWQgZGF0YSBmb3IgbmV3IG1pY2UgYnkgc2ltdWx0aW5nIHRoZSBtb3VzZSBlZmZlY3QgZnJvbSBhIG5vcm1hbCBkaXN0cmlidXRpb24uCgoKCiMjIEltcGFjdCBvZiB0aGUgYW1vdW50IG9mIHZhcmlhYmlsaXR5IG9mIHRoZSBibG9ja2luZyBmYWN0b3Igb24gdGhlIHBvd2VyPyAKCldlIHdpbGwgdmFyeSAKJCQKXGZyYWN7XHNpZ21hXjJfXHRleHR7YmV0d2Vlbn19e1xzaWdtYV4yX1x0ZXh0e2JldHdlZW59K1xzaWdtYV4yX1x0ZXh0e3dpdGhpbn19PTEtXGZyYWN7XHNpZ21hXjJfXHRleHR7d2l0aGlufX17XHNpZ21hXjJfXHRleHR7YmV0d2Vlbn0rXHNpZ21hXjJfXHRleHR7d2l0aGlufX0KJCQKU28gaW4gb3VyIGV4YW1wbGUgdGhhdCBpcyB0aGUgcmF0aW8gYmV0d2VlbiB0aGUgdmFyaWFiaWxpdHkgYmV0d2VlbiB0aGUgcmF0cyBhbmQgdGhlIHN1bSBvZiB0aGUgdmFyaWFiaWxpdHkgYmV0d2VlbiBhbmQgd2l0aGluIHRoZSByYXRzLiBOb3RlLCB0aGF0IHRoZSBsYXR0ZXIgd2FzIHRoZSB2YXJpYW5jZSBvZiB0aGUgZXJyb3JzIG9mIHRoZSBSQ0IgYW5kIGVxdWFscwoKYGBge3J9CnZhckJldHdlZW5QbHVzV2l0aGluIDwtIHN1bShjYXI6OkFub3ZhKGxtUkNCLHR5cGU9IklJSSIpW2MoIm1vdXNlIiwiUmVzaWR1YWxzIiksIlN1bSBTcSJdKS9zdW0oY2FyOjpBbm92YShsbVJDQix0eXBlPSJJSUkiKVtjKCJtb3VzZSIsIlJlc2lkdWFscyIpLCJEZiJdKQp2YXJXaXRoaW4gPC0gY2FyOjpBbm92YShsbVJDQilbIlJlc2lkdWFscyIsIlN1bSBTcSJdL2Nhcjo6QW5vdmEobG1SQ0IpWyJSZXNpZHVhbHMiLCJEZiJdCnZhckJldHdlZW5QbHVzV2l0aGluCnZhcldpdGhpbgoxLSB2YXJXaXRoaW4vdmFyQmV0d2VlblBsdXNXaXRoaW4KYGBgCgoKYGBge3J9CmFscGhhIDwtIDAuMDUKblNpbSA8LSAyMDAwMApiMCA8LSAwCnZhckJldHdlZW5QbHVzV2l0aGluIDwtIHN1bShjYXI6OkFub3ZhKGxtUkNCLHR5cGU9IklJSSIpW2MoIm1vdXNlIiwiUmVzaWR1YWxzIiksIlN1bSBTcSJdKS9zdW0oY2FyOjpBbm92YShsbVJDQix0eXBlPSJJSUkiKVtjKCJtb3VzZSIsIlJlc2lkdWFscyIpLCJEZiJdKQogCgpucyA8LSAgYygzLDcpICAKZGVsdGFzIDwtIGxtUkNCJGNvZWZmaWNpZW50c1siY2VsbHR5cGVUcmVnIl0KCmZyYWNWYXJzIDwtIHNlcSgwLC45NSwuMDUpCgpwb3dlckZhc3RCbG9ja2luZ0xvdyA8LSBtYXRyaXgoTkEsbnJvdz1sZW5ndGgobnMpKmxlbmd0aChmcmFjVmFycyksbmNvbD0zKSAlPiUgYXMuZGF0YS5mcmFtZQpuYW1lcyhwb3dlckZhc3RCbG9ja2luZ0xvdykgPC0gYygiZnJhY1ZhcnMiLCJuIiwicG93ZXIiKQoKaSA8LSAwCgoKZm9yIChuIGluIG5zKQp7CiAgCiAgIyMjIFNpbXVsYXRpb24KICBwcmVkaWN0b3JEYXRhIDwtIGRhdGEuZnJhbWUoY2VsbHR5cGUgPSByZXAoYygiVGNvbiIsIlRyZWciKSxlYWNoPW4pICU+JSBhcy5mYWN0b3IsIG1vdXNlID0gcGFzdGUwKCJtIixyZXAoMTpuLDIpKSkKICBkZXNpZ24gPC0gbW9kZWwubWF0cml4KH4gY2VsbHR5cGUgKyBtb3VzZSxwcmVkaWN0b3JEYXRhKQogIEwgPC0gbGltbWE6Om1ha2VDb250cmFzdHMoImNlbGx0eXBlVHJlZyIsbGV2ZWxzPWNvbG5hbWVzKGRlc2lnbikpCiAgZm9yIChmcmFjVmFyIGluIGZyYWNWYXJzKQogIHsKICBzZCA8LSBzcXJ0KHZhckJldHdlZW5QbHVzV2l0aGluKigxLWZyYWNWYXIpKQogIHNkTW91c2UgPC0gc3FydCh2YXJCZXR3ZWVuUGx1c1dpdGhpbipmcmFjVmFyKSAKICBmb3IgKGIxIGluIGRlbHRhcykKICB7CiAgICB5U2ltIDwtIHJub3JtKG5yb3cocHJlZGljdG9yRGF0YSkqblNpbSxzZD1zZCkKICAgIGRpbSh5U2ltKSA8LWMobnJvdyhwcmVkaWN0b3JEYXRhKSxuU2ltKQogICAgbW91c2VFZmZlY3QgPC0gcm5vcm0obiwgc2QgPSBzZE1vdXNlKQogICAgYmV0YXNNb3VzZSA8LSBtb3VzZUVmZmVjdFstMV0tbW91c2VFZmZlY3RbMV0KICAgIHlTaW0gPC0geVNpbSArIGMoZGVzaWduICUqJWMoYjAsYjEsYmV0YXNNb3VzZSkpCiAgICB5U2ltIDwtIHQoeVNpbSkKICAKICAgICMjIyBGaXR0aW5nCiAgICBmaXRBbGwgPC0gbGltbWE6OmxtRml0KHlTaW0sZGVzaWduKQogIAogICAgIyMjIEluZmVyZW5jZQogICAgdmFyVW5zY2FsZWQgPC0gYyh0KEwpJSolZml0QWxsJGNvdi5jb2VmZmljaWVudHMlKiVMKQogICAgY29udHJhc3RzIDwtIGZpdEFsbCRjb2VmZmljaWVudHMgJSolTAogICAgc2VDb250cmFzdHMgPC0gdmFyVW5zY2FsZWReLjUqZml0QWxsJHNpZ21hCiAgICB0c3RhdHMgPC0gY29udHJhc3RzL3NlQ29udHJhc3RzCiAgICBwdmFscyA8LSBwdChhYnModHN0YXRzKSxmaXRBbGwkZGYucmVzaWR1YWwsbG93ZXIudGFpbCA9IEZBTFNFKSoyCiAgICAKICAgIGkgPC0gaSsxCiAgICBwb3dlckZhc3RCbG9ja2luZ0xvd1tpLF0gPC0gYyhmcmFjVmFyLG4sbWVhbihwdmFscyA8IGFscGhhKSkKICB9CiAgfQp9CnBvd2VyRmFzdEJsb2NraW5nTG93CmBgYAoKYGBge3J9CmdnX2NvbG9yX2h1ZSA8LSBmdW5jdGlvbihuKSB7CiAgaHVlcyA9IHNlcSgxNSwgMzc1LCBsZW5ndGggPSBuICsgMSkKICBoY2woaCA9IGh1ZXMsIGwgPSA2NSwgYyA9IDEwMClbMTpuXQp9CmNvbHMgPC0gZ2dfY29sb3JfaHVlKDIpCgpwb3dlckZhc3RCbG9ja2luZ0xvdyAlPiUgCiAgYXMuZGF0YS5mcmFtZSAlPiUKICBtdXRhdGUobiA9IGFzLmZhY3RvcihuKSkgJT4lCiAgZ2dwbG90KGFlcyhmcmFjVmFycyxwb3dlcixncm91cD1uLGNvbG9yPW4pKSArCiAgZ2VvbV9saW5lKCkgKwogIGdlb21faGxpbmUoeWludGVyY2VwdCA9IHBvd2VyRmFzdCAlPiUgZmlsdGVyKG49PTMpICU+JSBwdWxsKHBvd2VyKSxjb2xvcj1jb2xzWzFdKSArCiAgYW5ub3RhdGUoInRleHQiLCBsYWJlbCA9ICJDUkQgKG49MykiLAogICAgeCA9IDAuMDUsIHkgPSBwb3dlckZhc3QgJT4lIGZpbHRlcihuPT0zKSAlPiUgcHVsbChwb3dlcikgKy4wMiwgc2l6ZSA9IDMsIGNvbG91ciA9IGNvbHNbMV0pICsKICAgIGdlb21faGxpbmUoeWludGVyY2VwdCA9IHBvd2VyRmFzdCAlPiUgZmlsdGVyKG49PTcpICU+JSBwdWxsKHBvd2VyKSxjb2xvcj1jb2xzWzJdKSArCiAgICBhbm5vdGF0ZSgidGV4dCIsIGxhYmVsID0gIkNSRCAobj03KSIsCiAgICB4ID0gMC4wNSwgeSA9IHBvd2VyRmFzdCAlPiUgZmlsdGVyKG49PTcpICU+JSBwdWxsKHBvd2VyKSArLjAyLCBzaXplID0gMywgY29sb3VyID0gY29sc1syXSkgKwogIHhsYWIoZXhwcmVzc2lvbih+c2lnbWFbYmV0d2Vlbl1eMi8oc2lnbWFbYmV0d2Vlbl1eMitzaWdtYVt3aXRoaW5dXjIpKSkgKwogIGdlb21fdmxpbmUoeGludGVyY2VwdD0xLXZhcldpdGhpbi92YXJCZXR3ZWVuUGx1c1dpdGhpbikgKwogIHhsaW0oMCwxKQpgYGAKCi0gU28gaWYgdGhlIHZhcmlhbmNlIHRoYXQgaXMgZXhwbGFpbmVkIGJ5IHRoZSBibG9jayBlZmZlY3QgaXMgc21hbGwgeW91IHdpbGwgbG9vc2UgcG93ZXIgYXMgY29tcGFyZWQgdG8gdGhlIGFuYWx5c2lzIHdpdGggYSBDUkQgZGVzaWduLiAKLSBBcyBzb29uIGFzIHRoZSBibG9jayBlZmZlY3QgZXhwbGFpbnMgYSBsYXJnZSBwYXJ0IG9mIHRoZSB2YXJpYWJpbGl0eSBpdCBpcyB2ZXJ5IGJlbmVmaWNpYWwgdG8gdXNlIGEgcmFuZG9taXplZCBjb21wbGV0ZSBibG9jayBkZXNpZ24hIAotIE5vdGUsIHRoYXQgdGhlIHNhbWUgbnVtYmVyIG9mIG1hc3Mgc3BlY3Ryb21ldHJ5IHJ1bnMgaGF2ZSB0byBiZSBkb25lIGZvciBib3RoIFJDQiBhbmQgQ1JEIGRlc2lnbi4gSG93ZXZlciwgZm9yIHRoZSBSQ0Igd2Ugb25seSBuZWVkIGhhbGYgb2YgdGhlIHJhdHMgYW5kIHdlIGhhdmUgYSBtdWNoIGhpZ2hlciBwb3dlciBmb3IgdGhpcyBzdHVkeSEgCgojIFBlbmlsaW4gZXhhbXBsZQoKVGhlIHByb2R1Y3Rpb24gb2YgcGVuaWNpbGxpbiBjb3JuIHN0ZWVwIGxpcXVvciBpcyB1c2VkLiBDb3JuIHN0ZWVwIGxpcXVvciBpcyBwcm9kdWNlZCBpbiBibGVuZHMgYW5kIHRoZXJlIGlzIGEgY29uc2lkZXJhYmxlIHZhcmlhYmlsaXR5IGJldHdlZW4gdGhlIGJsZW5kcy4gU3VwcG9zZSB0aGF0CgotIGZvdXIgY29tcGV0aW5nIG1ldGhvZHMgaGF2ZSB0byBiZSBldmFsdWF0ZWQgdG8gcHJvZHVjZSBwZW5pY2lsbGluIChBLUQpLAotIG9uZSBibGVuZHMgaXMgc3VmZmljaWVudCBmb3IgZm91ciBydW5zIG9mIGEgcGVuaWNpbGxpbiBiYXRjaCByZWFjdG9yIGFuZAotIHRoZSAyMCBydW5zIGNhbiBiZSBzY2hlZHVsZWQgZm9yIHRoZSBleHBlcmltZW50LiAKCkhvdyB3b3VsZCB5b3UgYXNzaWduIHRoZSBtZXRob2RzIHRvIHRoZSBibGVuZHMuCgpgYGB7cn0KZGF0YShwZW5pY2lsbGluLCBwYWNrYWdlPSJmYXJhd2F5IikKdGFibGUocGVuaWNpbGxpbiRibGVuZCxwZW5pY2lsbGluJHRyZWF0KQpgYGAKCkRhdGEKCmBgYHtyfQpoZWFkKHBlbmljaWxsaW4pCm1hdHJpeChwZW5pY2lsbGluJHlpZWxkLG5yb3c9NSxuY29sPTQsYnlyb3c9VFJVRSxkaW1uYW1lcz1saXN0KGxldmVscyhwZW5pY2lsbGluJGJsZW5kKSxsZXZlbHMocGVuaWNpbGxpbiR0cmVhdCkpKQpgYGAKCmBgYHtyfQpwZW5pY2lsbGluICU+JSAKICBnZ3Bsb3QoYWVzKHggPSBibGVuZCwgeSA9IHlpZWxkLCBncm91cCA9IHRyZWF0LCBjb2xvciA9IHRyZWF0KSkgKyAKICBnZW9tX2xpbmUoKSArCiAgZ2VvbV9wb2ludCgpCmBgYAoKYGBge3J9CnBlbmljaWxsaW4gJT4lIAogIGdncGxvdChhZXMoeCA9IHRyZWF0LCB5ID0geWllbGQsIGdyb3VwID0gYmxlbmQsIGNvbG9yID0gYmxlbmQpKSArIAogIGdlb21fbGluZSgpICsKICBnZW9tX3BvaW50KCkKYGBgCgojIyBBbmFseXNpcwoKYGBge3J9CmxtUGVuIDwtIGxtKHlpZWxkfnRyZWF0ICsgYmxlbmQsIGRhdGEgPSBwZW5pY2lsbGluKQpwbG90KGxtUGVuKQpjYXI6OkFub3ZhKGxtUGVuLHR5cGU9IklJSSIpCmBgYAoKV2UgY29uY2x1ZGUgdGhhdCB0aGUgZWZmZWN0IG9mIHRoZSB0cmVhdG1lbnQgb24gdGhlIHBlbmljaWxsaW4geWllbGQgaXMgbm90IHNpZ25pZmljYW50IGF0IHRoZSA1JSBsZXZlbCBvZiBzaWduaWZpY2FuY2UgKHAgPSBgciBjYXI6OkFub3ZhKGxtUGVuLHR5cGU9IklJSSIpWyJ0cmVhdCIsIlByKD5GKSJdICU+JSByb3VuZCguLDIpYC4KCldlIGFsc28gb2JzZXJ2ZSB0aGF0IHRoZXJlIGlzIGEgbGFyZ2UgZWZmZWN0IG9mIHRoZSBibGVuZCBvbiB0aGUgeWllbGQuIApCbGVuZCBleHBsYWlucyBhYm91dCBgciByb3VuZChjYXI6OkFub3ZhKGxtUGVuLHR5cGU9IklJSSIpWyJibGVuZCIsIlN1bSBTcSJdL3N1bShjYXI6OkFub3ZhKGxtUGVuLHR5cGU9IklJSSIpWy0xLCJTdW0gU3EiXSkqMTAwLDEpYCUgb2YgdGhlIHZhcmlhYmlsaXR5IGluIHRoZSBwZW5pY2lsbGluIHlpZWxkLgoKCiMgUHNldWRvLXJlcGxpY2F0aW9uCgojIyBCYWNrZ3JvdW5kCgpBIHN0dWR5IG9uIHRoZSBmYWN1bHRhdGl2ZSBwYXRob2dlbiBGcmFuY2lzZWxsYSB0dWxhcmVuc2lzIHdhcyBjb25jZWl2ZWQgYnkgUmFtb25kIGV0IGFsLiAoMjAxNSkgWzEyXS4gCgotIEYuIHR1bGFyZW5zaXMgZW50ZXJzIHRoZSBjZWxscyBvZiBpdHMgaG9zdCBieSBwaGFnb2N5dG9zaXMuIAotIFRoZSBhdXRob3JzIHNob3dlZCB0aGF0IEYuIHR1bGFyZW5zaXMgaXMgYXJnaW5pbmUgZGVmaWNpZW50IGFuZCBpbXBvcnRzIGFyZ2luaW5lIGZyb20gdGhlIGhvc3QgY2VsbCB2aWEgYW4gYXJnaW5pbmUgdHJhbnNwb3J0ZXIsIEFyZ1AsIGluIG9yZGVyIHRvIGVmZmljaWVudGx5IGVzY2FwZSBmcm9tIHRoZSBwaGFnb3NvbWUgYW5kIHJlYWNoIHRoZSBjeXRvc29saWMgY29tcGFydG1lbnQsIHdoZXJlIGl0IGNhbiBhY3RpdmVseSBtdWx0aXBseS4gCi0gSW4gdGhlaXIgc3R1ZHksIHRoZXkgY29tcGFyZWQgdGhlIHByb3Rlb21lIG9mIHdpbGQgdHlwZSBGLiB0dWxhcmVuc2lzIChXVCkgdG8gQXJnUC1nZW5lIGRlbGV0ZWQgRi4gdHVsYXJlbnNpcyAoa25vY2stb3V0LCBEOCkuIAoKLSBUaGUgc2FtcGxlIGZvciBlYWNoIGJpby1yZXAgd2FzIHJ1biBpbiB0ZWNobmljYWwgdHJpcGxpY2F0ZSBvbiB0aGUgbWFzcy1zcGVjdHJvbWV0ZXIuIAoKLSBXZSB3aWxsIHVzZSBkYXRhIGZvciB0aGUgcHJvdGVpbiA1MFMgcmlib3NvbWFsIHByb3RlaW4gTDUgW0EwUTRKNV0oaHR0cHM6Ly93d3cudW5pcHJvdC5vcmcvdW5pcHJvdC9BMFE0SjUpCgojIyBEYXRhIGV4cGxvcmF0aW9uCgpgYGB7cn0KZnJhbmMgPC0gcmVhZF90c3YoImh0dHBzOi8vcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbS9zdGF0T21pY3MvUFNMUzIxL2RhdGEvZnJhbmNpc2VsbGFBMFE0SjUudHh0IikKZnJhbmMKYGBgCgpgYGB7cn0KZnJhbmMgJT4lIAogIGdncGxvdChhZXMoYmlvcmVwLCBpbnRlbnNpdHlMb2cyLCBjb2xvciA9IGdlbm90eXBlKSkgKwogIGdlb21fcG9pbnQoKQpgYGAKCi0gUmVzcG9uc2U/IAotIEV4cGVyaW1lbnRhbCB1bml0PwotIE9ic2VydmF0aW9uYWwgdW5pdD8gCi0gRmFjdG9ycz8gCgokXHJpZ2h0YXJyb3ckIFBzZXVkby1yZXBsaWNhdGlvbiwgcmFuZG9taXNhdGlvbiB0byBiaW8tcmVwZWF0IGFuZCBlYWNoIGJpby1yZXBlYXQgbWVhc3VyZWQgaW4gdGVjaG5pY2FsIHRyaXBsaWNhdGUuCiRccmlnaHRhcnJvdyQgSWYgd2Ugd291bGQgYW5hbHlzZSB0aGUgZGF0YSB1c2luZyBhIGxpbmVhciBtb2RlbCBiYXNlZCBvbiBlYWNoIG1lYXN1cmVkIGludGVuc2l0eSwgd2Ugd291bGQgYWN0IGFzIGlmIHdlIGhhZCBzYW1wbGVkIDE4IGJpby1yZXBlYXRzLgokXHJpZ2h0YXJyb3ckIEVmZmVjdCBvZiBpbnRlcmVzdCBoYXMgdG8gYmUgYXNzZXNzZWQgYmV0d2VlbiBiaW8tcmVwZWF0cy4gU28gYmxvY2sgYW5hbHlzaXMgbm90IHBvc3NpYmxlISAKCklmIHRoZSBzYW1lIG51bWJlciBvZiBwc2V1ZG8tcmVwbGljYXRlcy90ZWNobmljYWwgcmVwbGljYXRlcyBhcmUgYXZhaWxhYmxlIGZvciBlYWNoIGJpby1yZXBlYXQ6CgotIGF2ZXJhZ2UgZmlyc3Qgb3ZlciBiaW8tcmVwZWF0cyB0byBvYnRhaW4gaW5kZXBlbmRlbnQgbWVhc3VyZW1lbnRzLiAgCi0gYXZlcmFnZXMgd2lsbCB0aGVuIGhhdmUgdGhlIHNhbWUgcHJlY2lzaW9uCi0gYXNzZXNzIGVmZmVjdCBvZiB0cmVhdG1lbnQgdXNpbmcgYXZlcmFnZXMKCmBgYHtyfQpsbUJpb3JlcCA8LSBsbShpbnRlbnNpdHlMb2cyIH4gLTEgKyBiaW9yZXAsIGZyYW5jKQpsbUJpb3JlcApgYGAKCmBgYHtyfQpmcmFuY1N1bSA8LSBkYXRhLmZyYW1lKGdlbm90eXBlID0gcmVwKGMoIkQ4IiwiV1QiKSxlYWNoPTMpICU+JSBhcy5mYWN0b3IgJT4lIHJlbGV2ZWwoIldUIiksIGludGVuc2l0eUxvZzIgPSBsbUJpb3JlcCRjb2VmKQpmcmFuY1N1bQpgYGAKCmBgYHtyfQpsbVN1bSA8LSBsbShpbnRlbnNpdHlMb2cyIH4gZ2Vub3R5cGUsIGZyYW5jU3VtKQpzdW1tYXJ5KGxtU3VtKQpgYGAKCiMjIFdyb25nIGFuYWx5c2lzIAoKYGBge3J9CmxtV3JvbmcgPC0gbG0oaW50ZW5zaXR5TG9nMiB+IGdlbm90eXBlLCBmcmFuYykKc3VtbWFyeShsbVdyb25nKQpgYGAKCk5vdGUsIHRoYXQgdGhlIGFuYWx5c2lzIHdoZXJlIHdlIGlnbm9yZSB0aGUgZmFjdCB0aGF0IHdlIGhhdmUgbXVsdGlwbGUgdGVjaG5pY2FsIHJlcGVhdHMgZm9yIGVhY2ggYmlvLXJlcGVhdCByZXR1cm5zIHJlc3VsdHMgdGhhdCBhcmUgd2F5IHRvbyBsaWJlcmFsLiAKCiMjIyBObyBUeXBlIEkgZXJyb3IgY29udHJvbCEKCmBgYHtyfQpzaWdtYVdpdGhpbiA8LSBzaWdtYShsbUJpb3JlcCkKc2lnbWFCZXR3ZWVuIDwtIHNpZ21hKGxtU3VtKQp4QmlvcmVwIDwtIG1vZGVsLm1hdHJpeCh+LTErYmlvcmVwLGZyYW5jKQp4V3JvbmcgPC0gbW9kZWwubWF0cml4KH5nZW5vdHlwZSxmcmFuYykKCgpzZXQuc2VlZCgyNTIzKQpuU2ltIDwtIDEwMDAKcmVzV3JvbmcgPC0gbWF0cml4KE5BLG5TaW0sNCkgJT4lIGFzLmRhdGEuZnJhbWUKbmFtZXMocmVzV3JvbmcpIDwtIGMoIkVzdGltYXRlIiwiU3RkLiBFcnJvciIsInQgdmFsdWUiLCJwdmFsdWUiKQpyZXNDb3JyZWN0IDwtIHJlc1dyb25nCmdlbm90eXBlIDwtIGZyYW5jJGdlbm90eXBlCmdlbm90eXBlU3VtIDwtIGZyYW5jU3VtJGdlbm90eXBlCmJpb3JlcCA8LSBmcmFuYyRiaW9yZXAKCmZvciAoaSBpbiAxOm5TaW0pCnsKYmlvcmVwU2ltIDwtIHJub3JtKG5jb2woeEJpb3JlcCksc2Q9c2lnbWFCZXR3ZWVuKQp5U2ltIDwtIHhCaW9yZXAlKiViaW9yZXBTaW0gKyBybm9ybShucm93KHhCaW9yZXApLHNkPXNpZ21hV2l0aGluKQp5U3VtIDwtIGxtKHlTaW1+YmlvcmVwKSRjb2VmZmljaWVudApyZXNXcm9uZ1tpLF0gPC0gc3VtbWFyeShsbSh5U2ltfmdlbm90eXBlKSkkY29lZmZpY2llbnRbMixdCnJlc0NvcnJlY3RbaSxdPC1zdW1tYXJ5KGxtKHlTdW1+Z2Vub3R5cGVTdW0pKSRjb2VmZmljaWVudFsyLF0KfQptZWFuKHJlc0NvcnJlY3QkcHZhbHVlIDwgMC4wNSkKbWVhbihyZXNXcm9uZyRwdmFsdWUgPCAwLjA1KQpgYGAKCmBgYHtyfQpxcGxvdChyZXNDb3JyZWN0JHB2YWx1ZSxnZW9tID0gImhpc3RvZ3JhbSIsYm91bmRhcnk9YygwLDEpKSArCiAgc3RhdF9iaW4oYnJlYWtzPXNlcSgwLDEsLjEpKSArCiAgeGxhYigicHZhbHVlIikgKwogIGdndGl0bGUoIkNvcnJlY3QgYW5hbHlzaXMiKQogIApxcGxvdChyZXNXcm9uZyRwdmFsdWUsZ2VvbSA9ICJoaXN0b2dyYW0iLGJvdW5kYXJ5PWMoMCwxKSkgKwogIHN0YXRfYmluKGJyZWFrcz1zZXEoMCwxLC4xKSkgKwogIHhsYWIoInB2YWx1ZSIpICsKICBnZ3RpdGxlKCJXcm9uZyBhbmFseXNpcyIpCmBgYAoKLSBTbyB3ZSBvYnNlcnZlIHRoYXQgdGhlIGFuYWx5c2lzIHRoYXQgZG9lcyBub3QgYWNjb3VudCBmb3IgcHNldWRvLXJlcGxpY2F0aW9uIGlzIHRvbyBsaWJlcmFsISAKCi0gVGhlIGFuYWx5c2lzIHRoYXQgZmlyc3Qgc3VtbWFyaXplcyBvdmVyIHRoZSB0ZWNobmljYWwgcmVwZWF0cyBsZWFkcyB0byBjb3JyZWN0IHAtdmFsdWVzIGFuZCBjb3JyZWN0IHR5cGUgSSBlcnJvciBjb250cm9sISAKCi0gQ2F1dGlvbjogTkVWRVIgU1VNTUFSSVpFIE9WRVIgVEhFIEJJT1JFUEVBVFMhCgotIFdoYXQgdG8gZG8gd2hlbiB5b3UgaGF2ZSBhbiB1bmVxdWFsIG51bWJlciBvZiB0ZWNobmljYWwgcmVwZWF0czogbW9yZSBhZHZhbmNlZCBtZXRob2RzIGFyZSByZXF1aXJlZAoKICAtIGUuZy4gbWl4ZWQgbW9kZWxzIAogIC0gVGhlIG1peGVkIG1vZGVsIGZyYW1ld29yayBjYW4gbW9kZWwgdGhlIGNvcnJlbGF0aW9uIHN0cnVjdHVyZSBpbiB0aGUgZGF0YQogIC0gTWl4ZWQgbW9kZWxzIGNhbiBhbHNvIGJlIHVzZWQgd2hlbiBpbmZlcmVuY2UgYmV0d2VlbiBhbmQgd2l0aGluIGJsb2NrcyBpcyBuZWVkZWQsIGUuZy4gc3BsaXQtcGxvdCBkZXNpZ25zLiAKCiMgTmF0dXJlIG1ldGhvZHM6IFNwbGl0LXBsb3QgZGVzaWducwoKW10oaHR0cHM6Ly93d3cubmF0dXJlLmNvbS9hcnRpY2xlcy9ubWV0aC4zMjkzLnBkZikgIAo=</div>
<div class="footer">
    <hr>
    This work is licensed under the <a href= "https://creativecommons.org/licenses/by-nc-sa/4.0">
    CC BY-NC-SA 4.0</a> licence.
</div>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeSourceEmbed("03-experimentalDesignIII.Rmd");
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
